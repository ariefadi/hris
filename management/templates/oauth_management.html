<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Management - Dynamic Refresh Token</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .oauth-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .oauth-card:hover {
            transform: translateY(-2px);
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        .token-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .btn-oauth {
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
        }
        .loading {
            display: none;
        }
        .oauth-instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 10px 10px 0;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h2><i class="fas fa-key text-primary"></i> OAuth Management</h2>
                    <p class="text-muted">Kelola refresh token Google Ad Manager secara dinamis</p>
                </div>

                <!-- User Info Card -->
                <div class="card oauth-card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user"></i> Informasi User</h5>
                    </div>
                    <div class="card-body">
                        {% if current_user %}
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Email:</strong> {{ current_user.user_mail }}
                                </div>
                                <div class="col-md-6">
                                    <strong>Nama:</strong> {{ current_user.user_alias|default:"Unknown" }}
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> User tidak ditemukan dalam session
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- OAuth Status Card -->
                <div class="card oauth-card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Status OAuth Token</h5>
                    </div>
                    <div class="card-body">
                        {% if oauth_status %}
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span><strong>Status Token:</strong></span>
                                {% if oauth_status.has_token %}
                                    <span class="badge bg-success status-badge">
                                        <i class="fas fa-check-circle"></i> Aktif
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger status-badge">
                                        <i class="fas fa-times-circle"></i> Tidak Aktif
                                    </span>
                                {% endif %}
                            </div>

                            <div class="token-info">
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Panjang Token:</small><br>
                                        <strong>{{ oauth_status.token_length }} karakter</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Terakhir Update:</small><br>
                                        <strong>{{ oauth_status.updated_at|default:"Belum pernah" }}</strong>
                                    </div>
                                </div>
                            </div>

                            {% if not oauth_status.has_token %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    Refresh token diperlukan untuk mengakses Google Ad Manager API
                                </div>
                            {% endif %}
                        {% elif oauth_error %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i> {{ oauth_error }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- OAuth Actions Card -->
                <div class="card oauth-card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs"></i> Aksi OAuth</h5>
                    </div>
                    <div class="card-body">
                        <!-- Target Email (opsional) -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Email Target (opsional):</strong></label>
                            <input type="email" id="targetEmail" class="form-control" placeholder="contoh: user@domain.com">
                            <small class="form-text text-muted">Isi jika ingin mengelola token untuk akun lain.</small>
                        </div>
                        <!-- Generate OAuth URL Button -->
                        <button id="generateOAuthBtn" class="btn btn-primary btn-oauth me-2 mb-2">
                            <i class="fas fa-link"></i> Generate OAuth URL
                        </button>

                        <!-- Refresh Status Button -->
                        <button id="refreshStatusBtn" class="btn btn-outline-info btn-oauth mb-2">
                            <i class="fas fa-sync-alt"></i> Refresh Status
                        </button>

                        <!-- Loading indicator -->
                        <div id="loading" class="loading text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Memproses...</p>
                        </div>

                        <!-- OAuth URL Display -->
                        <div id="oauthUrlSection" style="display: none;" class="mt-4">
                            <div class="oauth-instructions">
                                <h6><i class="fas fa-list-ol"></i> Instruksi OAuth:</h6>
                                <ol id="oauthInstructions"></ol>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label"><strong>OAuth URL:</strong></label>
                                <div class="input-group">
                                    <input type="text" id="oauthUrl" class="form-control" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyOAuthUrl()">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                    <button class="btn btn-primary" type="button" onclick="openOAuthUrl()">
                                        <i class="fas fa-external-link-alt"></i> Buka
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Authorization Code Input -->
                        <div id="authCodeSection" style="display: none;" class="mt-4">
                            <div class="mb-3">
                                <label for="authCode" class="form-label"><strong>Authorization Code:</strong></label>
                                <textarea id="authCode" class="form-control" rows="3" 
                                         placeholder="Paste authorization code dari URL redirect di sini..."></textarea>
                                <small class="form-text text-muted">
                                    Copy parameter 'code' dari URL redirect setelah memberikan izin
                                </small>
                            </div>
                            <button id="submitCodeBtn" class="btn btn-success btn-oauth">
                                <i class="fas fa-check"></i> Submit Code
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Show/Hide loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Show message
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const alertClass = type === 'error' ? 'alert-danger' : 
                              type === 'success' ? 'alert-success' : 'alert-info';
            
            messagesDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // Generate OAuth URL
        document.getElementById('generateOAuthBtn').addEventListener('click', function() {
            showLoading();
            
            const targetEmail = document.getElementById('targetEmail').value.trim();

            const payload = targetEmail ? { user_mail: targetEmail } : {};

            fetch('/management/admin/oauth/generate-url/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.status) {
                    // Show OAuth URL section
                    document.getElementById('oauthUrl').value = data.oauth_url;
                    
                    // Show instructions
                    const instructionsList = document.getElementById('oauthInstructions');
                    instructionsList.innerHTML = '';
                    data.instructions.forEach(instruction => {
                        const li = document.createElement('li');
                        li.textContent = instruction;
                        instructionsList.appendChild(li);
                    });
                    
                    document.getElementById('oauthUrlSection').style.display = 'block';
                    document.getElementById('authCodeSection').style.display = 'block';
                    
                    showMessage(`OAuth URL berhasil dibuat untuk ${data.user_name} (${data.user_mail})`, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showMessage('Error: ' + error.message, 'error');
            });
        });

        // Submit authorization code
        document.getElementById('submitCodeBtn').addEventListener('click', function() {
            const authCode = document.getElementById('authCode').value.trim();
            
            if (!authCode) {
                showMessage('Authorization code tidak boleh kosong', 'error');
                return;
            }
            
            showLoading();
            
            const targetEmailPost = document.getElementById('targetEmail').value.trim();
            const bodyPayload = targetEmailPost ? { code: authCode, user_mail: targetEmailPost } : { code: authCode };

            fetch('/management/admin/oauth/callback/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyPayload)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.status) {
                    showMessage(`✅ Refresh token berhasil disimpan untuk ${data.user_name}! Token length: ${data.token_length} karakter`, 'success');
                    
                    // Refresh page after 2 seconds
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showMessage('Error: ' + error.message, 'error');
            });
        });

        // Refresh status
        document.getElementById('refreshStatusBtn').addEventListener('click', function() {
            location.reload();
        });

        // Copy OAuth URL
        function copyOAuthUrl() {
            const oauthUrl = document.getElementById('oauthUrl');
            oauthUrl.select();
            document.execCommand('copy');
            showMessage('OAuth URL berhasil di-copy!', 'success');
        }

        // Open OAuth URL
        function openOAuthUrl() {
            const oauthUrl = document.getElementById('oauthUrl').value;
            window.open(oauthUrl, '_blank');
        }
    </script>
</body>
</html>