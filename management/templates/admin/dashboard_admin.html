{% extends "admin_base.html" %}
{% load static %}
{% block page_title %}Dashboard{% endblock %}
{% block page_heading %}Dashboard{% endblock %}
{% block more_stylesheet %}
<!-- Custom Dashboard CSS -->
<style>
.dashboard-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
}

.metric-card {
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    border-radius: 16px;
    padding: 18px 18px;
    margin-bottom: 20px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 14px 28px rgba(0, 0, 0, 0.18);
}

.metric-card::after {
    content: "";
    position: absolute;
    right: -40px;
    top: -40px;
    width: 140px;
    height: 140px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.18);
    filter: blur(0px);
}

.metric-card-inner {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.metric-card-icon {
    width: 54px;
    height: 54px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.18);
}

.metric-card-icon i {
    font-size: 1.6rem;
    color: #fff;
}

@media (max-width: 576px) {
    .metric-value {
        font-size: 2rem;
    }
}

.metric-card.users {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.metric-card.logins {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.metric-card.activity {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.metric-card.ads-accounts {
    background: linear-gradient(135deg, #ff4b1f 0%, #ff9068 100%);
}

.metric-card.adx-accounts {
    background: linear-gradient(135deg, #7f00ff 0%, #e100ff 100%);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 1rem;
    opacity: 0.9;
}

.chart-container {
    position: relative;
    height: 400px;
    margin: 20px 0;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.recent-logins {
    max-height: 400px;
    overflow-y: auto;
}

.login-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.login-item:last-child {
    border-bottom: none;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
}
.equal-group > * {
    flex: 1;
}

html[data-theme="dark"] #roiHourlyDetailModal > div {
    color: #212529 !important;
}
html[data-theme="dark"] #roiHourlyDetailModal th,
html[data-theme="dark"] #roiHourlyDetailModal td,
html[data-theme="dark"] #roiHourlyDetailModal #roiHourlyDetailTitle {
    color: #212529 !important;
}
</style>
{% endblock %}

{% block content %}
<main class="app-main">
    <div class="app-content">
        <div class="container-fluid">
            <!-- Loading Spinner -->
            <div id="loading" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                </div>
            </div>
            <!-- Error Message -->
            <div id="error-message" class="error-message" style="display: none;">
                <strong>Error:</strong> <span id="error-text"></span>
            </div>
            <!-- Dashboard Content -->
            <div id="dashboard-content" style="display: none;">
                <div class="row" id="metric-cards">
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="metric-card users">
                            <div class="metric-card-inner">
                                <div>
                                    <div class="metric-label">Total Users</div>
                                    <div class="metric-value" id="total-users">0</div>
                                </div>
                                <div class="metric-card-icon" aria-hidden="true">
                                    <i class="bi bi-people-fill"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="metric-card logins">
                            <div class="metric-card-inner">
                                <div>
                                    <div class="metric-label">Active Users (7 days)</div>
                                    <div class="metric-value" id="active-users">0</div>
                                </div>
                                <div class="metric-card-icon" aria-hidden="true">
                                    <i class="bi bi-person-check-fill"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="metric-card activity">
                            <div class="metric-card-inner">
                                <div>
                                    <div class="metric-label">Activity Rate</div>
                                    <div class="metric-value" id="activity-rate">0%</div>
                                </div>
                                <div class="metric-card-icon" aria-hidden="true">
                                    <i class="bi bi-graph-up"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Metrik Akun Ads & Adx -->
                <div class="row mt-2" id="ads-adx-cards">
                    <div class="col-12 col-sm-6 col-md-6">
                        <div class="metric-card ads-accounts">
                            <div class="metric-card-inner">
                                <div>
                                    <div class="metric-label">Ads Accounts</div>
                                    <div class="metric-value" id="ads-accounts-count">0</div>
                                </div>
                                <div class="metric-card-icon" aria-hidden="true">
                                    <i class="bi bi-facebook"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-6">
                        <div class="metric-card adx-accounts">
                            <div class="metric-card-inner">
                                <div>
                                    <div class="metric-label">Adx Accounts</div>
                                    <div class="metric-value" id="adx-accounts-count">0</div>
                                </div>
                                <div class="metric-card-icon" aria-hidden="true">
                                    <i class="bi bi-badge-ad-fill"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3" id="roi-kpi-cards">
                    <div class="col-md-8">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-bullseye me-2"></i> ROI & Pendapatan (Hari Ini)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="roiBulletChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-clock me-2"></i> Jam
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="roiClockGauge" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Earnings Comparison -->
                <div class="row mt-3" id="earnings-comparison">
                    <div class="col-md-12">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-cash-stack me-2"></i> Earning Comparison (7 Days)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 380px;">
                                    <canvas id="earningsComparisonChart" style="height: 360px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ROI Charts -->
                <div class="row mt-3" id="roi-charts">
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-activity me-2"></i> ROI per Domain (Bar)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <div id="roiDomainChart" style="height: 400px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="bi bi-file-word-fill"></i> ROI per Country (Wordcloud)
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Tinggi diseragamkan -->
                                <div id="roiCountryMap" style="height: 440px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ROI Chart per hour daily -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card dashboard-card">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <div class="row w-100">
                                    <div class="col-md-6 d-flex align-items-center">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-graph-up-arrow me-2"></i> ROI per Hour (Daily)
                                        </h5>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-center justify-content-md-end gap-3 equal-group">
                                        <label for="roi-hourly-account-filter" class="mb-0">AdX Account:</label>
                                        <select id="roi-hourly-account-filter" class="form-select"></select>
                                        <label for="roi-hourly-date" class="mb-0">Date:</label>
                                        <input id="roi-hourly-date" type="date" class="form-control" />
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 420px;">
                                    <canvas id="roiHourlyChart" style="height: 400px;"></canvas>
                                </div>
                                <div id="roiHourlyCountryList" class="mt-2"></div>
                                <div id="roiHourlyDetailModal" style="position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:1050;">
                                    <div style="background:#fff;max-width:900px;width:95%;max-height:80vh;overflow:auto;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2);">
                                        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eee;">
                                            <h6 id="roiHourlyDetailTitle" style="margin:0;">Detail</h6>
                                            <button id="roiHourlyDetailClose" type="button" class="btn btn-sm btn-outline-secondary">Close</button>
                                        </div>
                                        <div id="roiHourlyDetailBody" style="padding:12px 16px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Highcharts Maps (samakan dengan roi_traffic_country) -->
<script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highcharts@11.4.6/highmaps.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highcharts@11.4.6/highcharts-more.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highcharts@11.4.6/modules/solid-gauge.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highcharts@11.4.6/modules/bullet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highcharts@11.4.6/modules/exporting.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highcharts@11.4.6/modules/accessibility.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highcharts@11.4.6/modules/wordcloud.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@highcharts/map-collection@2.1.0/custom/world.js"></script>
<!-- Select2 (untuk Adx Account) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
let loginChart, userChart;
let roiDomainChart;
let earningsComparisonChart;

function showError(message) {
    const loading = document.getElementById('loading');
    const content = document.getElementById('dashboard-content');
    const box = document.getElementById('error-message');
    const text = document.getElementById('error-text');

    if (loading) loading.style.display = 'none';
    if (content) content.style.display = 'none';
    if (box) box.style.display = 'block';
    if (text) text.textContent = message || 'Unknown error';
}

// Fetch dashboard data
async function fetchDashboardData() {
    try {
        const response = await fetch('/management/admin/dashboard_data');
        // Check if redirected to login page
        if (response.url.includes('/login')) {
            window.location.href = '/management/admin/login';
            return;
        }
        const result = await response.json();
        if (result.status) {
            updateDashboard(result.data);
        } else {
            showError(result.error || 'Failed to load dashboard data');
        }
    } catch (error) {
        console.error('fetchDashboardData error:', error);
        showError('Failed to load dashboard data');
    }
}
// Update dashboard with data
function updateDashboard(data) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('dashboard-content').style.display = 'block';

    try {
        if (data.user_stats) {
        document.getElementById('total-users').textContent = data.user_stats.total_users;
        document.getElementById('active-users').textContent = data.user_stats.active_users;
        document.getElementById('activity-rate').textContent = data.user_stats.activity_rate + '%';
    }
    if (data.account_stats) {
        document.getElementById('ads-accounts-count').textContent = data.account_stats.ads_accounts_count ?? 0;
        document.getElementById('adx-accounts-count').textContent = data.account_stats.adx_accounts_count ?? 0;
        const accounts = data.account_stats.adx_accounts || [];
        const defaultMail = data.account_stats.default_selected_account || '';
        populateAccountFilter(accounts, defaultMail);
        populateHourlyAccountFilter(accounts, defaultMail);
    }
    if (data.charts && data.charts.earnings_comparison) {
        updateEarningsComparisonChart(data.charts.earnings_comparison);
    }
    if (data.charts && data.charts.login_activity) {
        if (typeof updateLoginChart === 'function') {
            updateLoginChart(data.charts.login_activity);
        }
        if (typeof updateUserChart === 'function') {
            updateUserChart(data.user_stats);
        }
    }
        if (data.recent_logins) {
            if (typeof updateRecentLogins === 'function') {
                updateRecentLogins(data.recent_logins);
            }
        }
    } finally {
        try {
            renderClockGauge();
        } catch (e) {
            console.error('renderClockGauge error:', e);
        }
        try {
            loadRoiKpiBullet();
        } catch (e) {
            console.error('loadRoiKpiBullet error:', e);
        }
    }
}
// Populate Adx account filter and trigger ROI load
function populateAccountFilter(accounts, defaultMail) {
    const sel = document.getElementById('account-filter');
    if (!sel) return;
    // Hancurkan Select2 sebelumnya bila ada
    if (window.jQuery && jQuery(sel).data('select2')) {
        jQuery(sel).select2('destroy');
    }
    // Bangun opsi
    sel.innerHTML = '';
    accounts.forEach(acc => {
        const opt = document.createElement('option');
        opt.value = acc.account_id || acc.user_mail || '';
        opt.textContent = acc.account_name || acc.user_mail || '(unknown)';
        sel.appendChild(opt);
    });
    // Inisialisasi Select2
    if (window.jQuery) {
        jQuery(sel).select2({
            placeholder: '-- Pilih Adx Account --',
            theme: 'bootstrap4',
            width: '100%',
                    allowClear: true
                });
            }
    // Select default
    if (defaultMail) {
        sel.value = defaultMail;
        if (!sel.value) {
            const mapped = (accounts || []).find(a => String(a.user_mail || '') === String(defaultMail || '') && String(a.account_id || ''));
            if (mapped) sel.value = mapped.account_id;
        }
    }
    const selectedAccountId = sel.value || (accounts[0]?.account_id || '') || (accounts[0]?.user_mail || '');
    if (selectedAccountId) {
        loadRoiData(selectedAccountId);
    }
    sel.onchange = () => loadRoiData(sel.value);
}
// Fetch and render ROI per Domain (line) and per Country (map)
async function loadRoiData(selectedAccountMail) {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;
    const startDate = todayStr;
    const endDate = todayStr;
    // ROI per Domain (referensi menu monitoring_domain, semua akun, Tanpa Spends aktif, data hari ini)
    const qsDomain = new URLSearchParams({
        start_date: startDate,
        end_date: endDate,
        selected_account_adx: '',
        selected_domains: ''
    });
    try {
        const resp = await fetch('/management/admin/page_monitoring_domain?' + qsDomain.toString());
        const json = await resp.json();
        if (json.status) {
            const base = Array.isArray(json.data_filtered)
                ? json.data_filtered
                : (Array.isArray(json.data) ? json.data : []).filter(it => Number((it || {}).spend || 0) > 0);
            renderRoiDomainChart(base);
        } else {
            renderRoiDomainChart([]); // clear
        }
    } catch (e) {
        renderRoiDomainChart([]);
        console.warn('ROI Domain fetch error:', e);
    }
    // ROI per Country (referensi dari menu monitoring_country, data hari ini)
    const qsCountry = new URLSearchParams({
        start_date: todayStr,
        end_date: todayStr,
        selected_account_adx: '',
        selected_domains: '',
        selected_countries: ''
    });
    try {
        const resp = await fetch('/management/admin/page_monitoring_country?' + qsCountry.toString());
        const json = await resp.json();
        if (json.status) {
            const base = Array.isArray(json.data_filtered)
                ? json.data_filtered
                : (Array.isArray(json.data) ? json.data : []).filter(it => Number((it || {}).spend || 0) > 0);
            renderRoiCountryMap(base);
        } else {
            renderRoiCountryMap([]); // clear
        }
    } catch (e) {
        renderRoiCountryMap([]);
        console.warn('ROI Country fetch error:', e);
    }
    return;
}
async function populateHourlyAccountFilter(accounts = [], defaultMail = '') {
    const sel = document.getElementById('roi-hourly-account-filter');
    if (!sel) return;
    if (window.jQuery && jQuery(sel).data('select2')) {
        jQuery(sel).select2('destroy');
    }
    sel.innerHTML = '';
    accounts.forEach(acc => {
        const opt = document.createElement('option');
        opt.value = acc.account_id || acc.user_mail || '';
        opt.textContent = acc.account_name || acc.user_mail || '(unknown)';
        sel.appendChild(opt);
    });
    if (window.jQuery) {
        jQuery(sel).select2({
            placeholder: '-- Pilih AdX Account --',
            theme: 'bootstrap4',
            width: '100%',
            allowClear: true
        });
    }
    if (defaultMail) sel.value = defaultMail;
    const chosen = sel.value || defaultMail || (accounts[0]?.account_id || '') || (accounts[0]?.user_mail || '');
    const dateInput = document.getElementById('roi-hourly-date');
    if (dateInput && !dateInput.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    }
    if (chosen) {
        loadRoiData(chosen);
    }
    if (chosen && dateInput && dateInput.value) {
        loadRoiHourlyData(chosen, dateInput.value);
    }
    sel.onchange = () => {
        const v = sel.value;
        const d = (document.getElementById('roi-hourly-date') || {}).value;
        if (v) loadRoiData(v);
        if (v && d) loadRoiHourlyData(v, d);
    };
    if (dateInput) {
        dateInput.addEventListener('change', () => {
            const v = sel.value || chosen;
            const d = dateInput.value;
            if (v) loadRoiData(v);
            if (v && d) loadRoiHourlyData(v, d);
        });
    }
}
async function loadRoiHourlyData(selectedAccount, dateStr) {
    const qs = new URLSearchParams({
        date: dateStr,
        selected_accounts: selectedAccount || '',
        selected_domains: ''
    });
    try {
        const resp = await fetch('/management/admin/page_roi_country_hourly?' + qs.toString());
        const json = await resp.json();
        if (json.status) {
            renderRoiHourlyChart(json);
        } else {
            renderRoiHourlyChart(null);
        }
    } catch (e) {
        console.warn('ROI Country Hourly fetch error:', e);
        renderRoiHourlyChart(null);
    }
}
// Build last 7 days date range (YYYY-MM-DD)
function getLast7DaysRange() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 6);
    const fmt = d => d.toISOString().slice(0,10);
    return { startDate: fmt(start), endDate: fmt(end) };
}
function formatIdr(value) {
    const num = Number(value || 0);
    return num.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 });
}
function formatYmdLocal(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
}
async function loadRoiKpiBullet() {
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    const todayStr = formatYmdLocal(today);
    const yestStr = formatYmdLocal(yesterday);

    const buildUrl = (dt) => {
        const qs = new URLSearchParams({
            start_date: dt,
            end_date: dt,
            selected_account_adx: '',
            selected_domains: '',
            selected_countries: ''
        });
        return '/management/admin/page_monitoring_country?' + qs.toString();
    };

    try {
        const [r1, r2] = await Promise.all([fetch(buildUrl(todayStr)), fetch(buildUrl(yestStr))]);
        const [j1, j2] = await Promise.all([r1.json(), r2.json()]);

        const s1 = (j1 && j1.status && j1.summary_filtered) ? j1.summary_filtered : null;
        const s2 = (j2 && j2.status && j2.summary_filtered) ? j2.summary_filtered : null;

        const revToday = Number((s1 || {}).total_revenue || 0);
        const roiToday = Number((s1 || {}).roi_nett || 0);
        const revYest = Number((s2 || {}).total_revenue || 0);
        const roiYest = Number((s2 || {}).roi_nett || 0);

        renderRoiBulletChart({
            todayStr,
            yestStr,
            revToday,
            roiToday,
            revYest,
            roiYest
        });
    } catch (e) {
        renderRoiBulletChart(null);
    }
}
function renderRoiBulletChart(m) {
    if (!window.Highcharts || !Highcharts.chart) return;

    const el = document.getElementById('roiBulletChart');
    if (!el) return;

    if (!Highcharts.seriesTypes || !Highcharts.seriesTypes.bullet) {
        el.innerHTML = 'Highcharts bullet module is not loaded';
        return;
    }

    if (!m) {
        el.innerHTML = '';
        return;
    }

    const revToday = Number(m.revToday || 0);
    const revYest = Number(m.revYest || 0);
    const roiToday = Number(m.roiToday || 0);
    const roiYest = Number(m.roiYest || 0);


    const revMaxVal = Math.max(revToday, revYest);
    const revAxisMax = revMaxVal > 0 ? Math.ceil(revMaxVal * 1.15) : 1;

    const roiMinVal = Math.min(roiToday, roiYest);
    const roiMaxVal = Math.max(roiToday, roiYest);
    const roiSpan = Math.abs(roiMaxVal - roiMinVal);
    const roiPad = Math.max(2, roiSpan * 0.2);
    const roiAxisMin = Math.floor(roiMinVal - roiPad);
    const roiAxisMax = Math.ceil(roiMaxVal + roiPad);


    const bands = (min, max) => {
        const a = Number(min || 0);
        const b = Number(max || 0);
        const lo = Math.min(a, b);
        const hi = Math.max(a, b);
        const span = Math.max(1, hi - lo);
        return [
            { from: lo, to: lo + span * 0.6, color: 'rgba(0,0,0,0.04)' },
            { from: lo + span * 0.6, to: lo + span * 0.85, color: 'rgba(0,0,0,0.08)' },
            { from: lo + span * 0.85, to: hi, color: 'rgba(0,0,0,0.12)' }
        ];
    };

    if (window.roiKpiBulletChart && typeof window.roiKpiBulletChart.destroy === 'function') {
        window.roiKpiBulletChart.destroy();
    }

    window.roiKpiBulletChart = Highcharts.chart('roiBulletChart', {
        chart: {
            inverted: true,
            type: 'bullet',
            backgroundColor: 'transparent',
            height: 300,
            marginLeft: 125,
            marginRight: 35,
            spacingTop: 10,
            spacingBottom: 10
        },
        title: { text: null },
        credits: { enabled: false },
        legend: { enabled: false },
        xAxis: [
            {
                categories: ['Pendapatan'],
                top: '0%',
                height: '50%',
                lineWidth: 0,
                tickLength: 0,
                labels: {
                    align: 'center',
                    x: -8,
                    style: { fontSize: '12px', fontWeight: '700' }
                }
            },
            {
                categories: ['Hasil ROI'],
                top: '50%',
                height: '50%',
                lineWidth: 0,
                tickLength: 0,
                labels: {
                    align: 'left',
                    x: -1,
                    style: { fontSize: '12px', fontWeight: '700' }
                }
            }
        ],
        yAxis: [
            {
                min: 0,
                max: revAxisMax,
                plotBands: bands(0, revAxisMax),
                labels: {
                    style: { fontSize: '10px' },
                    formatter: function () {
                        return Number(this.value || 0).toLocaleString('id-ID');
                    }
                },
                title: { text: null },
                gridLineWidth: 0,
                lineWidth: 0,
                tickLength: 6,
                tickWidth: 1,
                tickColor: 'rgba(0,0,0,0.18)',
                top: '0%',
                height: '50%'
            },
            {
                min: roiAxisMin,
                max: roiAxisMax,
                plotBands: bands(roiAxisMin, roiAxisMax),
                labels: {
                    style: { fontSize: '10px' },
                    formatter: function () {
                        return `${Number(this.value || 0).toFixed(0)}%`;
                    }
                },
                title: { text: null },
                gridLineWidth: 0,
                lineWidth: 0,
                tickLength: 6,
                tickWidth: 1,
                tickColor: 'rgba(0,0,0,0.18)',
                top: '50%',
                height: '50%'
            }
        ],
        tooltip: {
            useHTML: true,
            formatter: function () {
                const s = this.series || {};
                const p = this.point || {};
                if (s.name === 'Pendapatan') {
                    return `Pendapatan<br/>Hari ini: <b>${formatIdr(p.y || 0)}</b><br/>Kemarin: <b>${formatIdr(p.target || 0)}</b>`;
                }
                if (s.name === 'ROI') {
                    return `ROI<br/>Hari ini: <b>${Number(p.y || 0).toFixed(2)}%</b><br/>Kemarin: <b>${Number(p.target || 0).toFixed(2)}%</b>`;
                }
                return '';
            }
        },
        plotOptions: {
            series: {
                pointPadding: 0.18,
                borderWidth: 0,
                targetOptions: { width: '200%' },
                dataLabels: {
                    enabled: true,
                    inside: false,
                    align: 'left',
                    x: 10,
                    style: { fontWeight: '600' }
                }
            }
        },
        series: [
            {
                name: 'Pendapatan',
                xAxis: 0,
                yAxis: 0,
                color: '#4facfe',
                targetOptions: { color: '#2b90ff' },
                data: [{
                    y: revToday,
                    target: revYest,
                    dataLabels: { format: `Hari ini: ${formatIdr(revToday)}` }
                }]
            },
            {
                name: 'ROI',
                xAxis: 1,
                yAxis: 1,
                color: '#7f00ff',
                targetOptions: { color: '#7f00ff' },
                data: [{
                    y: roiToday,
                    target: roiYest,
                    dataLabels: { format: `Hari ini: ${roiToday.toFixed(2)}%` }
                }]
            }
        ]
    });
}
function renderClockGauge() {
    if (!window.Highcharts || !Highcharts.chart) return;

    const el = document.getElementById('roiClockGauge');
    if (!el) return;

    if (!Highcharts.seriesTypes || !Highcharts.seriesTypes.gauge) {
        el.innerHTML = 'Highcharts gauge is not available (highcharts-more not loaded)';
        return;
    }

    if (window.roiClockGaugeChart && typeof window.roiClockGaugeChart.destroy === 'function') {
        window.roiClockGaugeChart.destroy();
    }

    try {
        window.roiClockGaugeChart = Highcharts.chart('roiClockGauge', {
        chart: { type: 'gauge', backgroundColor: 'transparent' },
        title: { text: null },
        credits: { enabled: false },
        pane: {
            startAngle: 0,
            endAngle: 360,
            background: [{
                outerRadius: '100%',
                innerRadius: '60%',
                backgroundColor: 'rgba(0,0,0,0.03)',
                borderWidth: 0
            }]
        },
        yAxis: {
            min: 0,
            max: 12,
            tickInterval: 1,
            minorTickInterval: 0.5,
            labels: { distance: 18 },
            lineWidth: 0,
            tickLength: 8,
            minorTickLength: 4
        },
        tooltip: { enabled: false },
        series: [{
            name: 'Hour',
            data: [0],
            dial: {
                radius: '55%',
                baseLength: '0%',
                baseWidth: 6,
                rearLength: '0%'
            },
            pivot: { radius: 4 },
            dataLabels: { enabled: false }
        }, {
            name: 'Minute',
            data: [0],
            dial: {
                radius: '80%',
                baseLength: '0%',
                baseWidth: 4,
                rearLength: '0%'
            },
            pivot: { radius: 0 },
            dataLabels: { enabled: false }
        }, {
            name: 'Second',
            data: [0],
            dial: {
                radius: '90%',
                baseLength: '0%',
                baseWidth: 2,
                rearLength: '0%',
                backgroundColor: '#dc3545',
                borderColor: '#dc3545'
            },
            pivot: { radius: 0 },
            dataLabels: { enabled: false }
        }]
    });

    const update = () => {
        const now = new Date();
        let h = now.getHours() % 12;
        const m = now.getMinutes();
        const s = now.getSeconds();
        const hourVal = h + (m / 60);
        const minVal = (m / 60) * 12;
        const secVal = (s / 60) * 12;
        const c = window.roiClockGaugeChart;
        if (!c || !c.series || c.series.length < 3) return;
        c.series[0].points[0].update(hourVal, false);
        c.series[1].points[0].update(minVal, false);
        c.series[2].points[0].update(secVal, false);
        c.redraw();
    };

    update();
    if (window.roiClockGaugeTimer) {
        clearInterval(window.roiClockGaugeTimer);
    }
        window.roiClockGaugeTimer = setInterval(update, 1000);
    } catch (e) {
        console.error('roiClockGauge error:', e);
        el.innerHTML = String((e && e.message) ? e.message : e);
    }
}
function updateEarningsComparisonChart(payload) {
    const canvas = document.getElementById('earningsComparisonChart');
    if (!canvas) return;

    const labels = Array.isArray(payload?.labels) ? payload.labels : [];
    const adx = Array.isArray(payload?.adx_earnings) ? payload.adx_earnings : [];
    const adsense = Array.isArray(payload?.adsense_earnings) ? payload.adsense_earnings : [];

    const ctx = canvas.getContext('2d');
    if (earningsComparisonChart) earningsComparisonChart.destroy();

    earningsComparisonChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: ' Pendapatan Adx ',
                    data: adx,
                    borderColor: 'rgba(127, 0, 255, 1)',
                    backgroundColor: 'rgba(127, 0, 255, 0.18)',
                    pointBackgroundColor: 'rgba(127, 0, 255, 1)',
                    pointBorderColor: '#fff',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.35
                },
                {
                    label: ' Pendapatan AdSense ',
                    data: adsense,
                    borderColor: 'rgba(0, 212, 255, 1)',
                    backgroundColor: 'rgba(0, 212, 255, 0.14)',
                    pointBackgroundColor: 'rgba(0, 212, 255, 1)',
                    pointBorderColor: '#fff',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.35
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const v = context.parsed?.y ?? 0;
                            return `${context.dataset.label}: ${formatIdr(v)}`;
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { maxRotation: 0, autoSkip: true } },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            const num = Number(value || 0);
                            return num.toLocaleString('id-ID');
                        }
                    }
                }
            }
        }
    });
}
// Render ROI per Domain (Highcharts stacked bar)
function renderRoiDomainChart(items) {
    const el = document.getElementById('roiDomainChart');
    if (!el) return;

    if (!window.Highcharts || !Highcharts.chart) {
        console.error('Highcharts belum ter-load');
        return;
    }

    const raw = Array.isArray(items) ? items : [];

    const agg = new Map();
    raw.forEach(it => {
        const name = String((it || {}).site_name || '').trim();
        if (!name) return;
        const spend = Number((it || {}).spend || 0);
        const revenue = Number((it || {}).revenue || 0);
        const cur = agg.get(name) || { spend: 0, revenue: 0 };
        cur.spend += spend;
        cur.revenue += revenue;
        agg.set(name, cur);
    });

    const rows = Array.from(agg.entries()).map(([name, v]) => {
        const spend = Number(v.spend || 0);
        const revenue = Number(v.revenue || 0);
        const roi = spend > 0 ? ((revenue - spend) / spend * 100) : 0;
        return { name, spend, revenue, net: revenue - spend, roi };
    });

    rows.sort((a, b) => (b.roi || 0) - (a.roi || 0));
    const top = rows.slice(0, 12);

    const categories = top.map(r => r.name);
    const spendSeries = top.map(r => Math.round(r.spend || 0));
    const netSeries = top.map(r => Math.round(r.net || 0));

    if (roiDomainChart && typeof roiDomainChart.destroy === 'function') {
        roiDomainChart.destroy();
    }

    roiDomainChart = Highcharts.chart('roiDomainChart', {
        chart: { type: 'bar', backgroundColor: 'transparent' },
        title: { text: 'ROI per Domain (Hari Ini)' },
        subtitle: { text: 'Top 12 domain berdasarkan ROI (semua akun, Tanpa Spends aktif)' },
        credits: { enabled: false },
        xAxis: {
            categories,
            title: { text: null },
            labels: { style: { fontSize: '11px' } }
        },
        yAxis: {
            title: { text: null },
            labels: {
                formatter: function () {
                    const v = Number(this.value || 0);
                    return v.toLocaleString('id-ID');
                }
            }
        },
        legend: { reversed: true },
        tooltip: {
            useHTML: true,
            formatter: function () {
                const idx = this.point && typeof this.point.index === 'number' ? this.point.index : 0;
                const r = top[idx] || {};
                return `<b>${r.name || ''}</b><br/>Spend: <b>${formatIdr(r.spend || 0)}</b><br/>Pendapatan: <b>${formatIdr(r.revenue || 0)}</b><br/>ROI: <b>${Number(r.roi || 0).toFixed(2)}%</b>`;
            }
        },
        plotOptions: {
            series: {
                stacking: 'normal',
                borderWidth: 0
            }
        },
        series: [
            { name: 'Net (Revenue - Spend)', data: netSeries, color: '#43a047' },
            { name: 'Spend', data: spendSeries, color: '#ef5350' }
        ]
    });
}
// Render ROI per Country (Highcharts wordcloud)
function renderRoiCountryMap(items) {
    const raw = Array.isArray(items) ? items : [];

    if (!window.Highcharts || !Highcharts.chart) {
        console.error('Highcharts belum ter-load');
        return;
    }

    const points = raw
        .filter(it => Number(it.spend || 0) > 0)
        .map(it => {
            const name = String(it.country || it.country_code || '').trim();
            const revenue = Number(it.revenue || 0);
            const roi = Number(it.roi || 0);
            const spend = Number(it.spend || 0);
            const weight = Math.max(1, Math.sqrt(Math.max(0, revenue)));
            return { name, weight, revenue, roi, spend };
        })
        .filter(p => p.name);

    Highcharts.chart('roiCountryMap', {
        chart: { backgroundColor: 'transparent' },
        title: { text: 'ROI Per Negara (Hari Ini)' },
        subtitle: { text: 'Arahkan kursor ke nama negara untuk melihat detail' },
        credits: { enabled: false },
        tooltip: {
            useHTML: true,
            formatter: function() {
                const p = this.point || {};
                const rev = Number(p.revenue || 0);
                const roiVal = Number(p.roi || 0);
                return `<b>${p.name || ''}</b><br/>Pendapatan: <b>${formatIdr(rev)}</b><br/>ROI: <b>${roiVal.toFixed(2)}%</b>`;
            }
        },
        series: [{
            type: 'wordcloud',
            data: points,
            name: 'Negara',
            rotation: { from: 0, to: 0 },
            minFontSize: 10,
            maxFontSize: 60
        }]
    });
}
function renderRoiHourlyChart(payload) {
    const canvas = document.getElementById('roiHourlyChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (window.roiHourlyChart && typeof window.roiHourlyChart.destroy === 'function') {
        window.roiHourlyChart.destroy();
    }
    if (!payload || !payload.status) {
        window.roiHourlyChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        const listEl = document.getElementById('roiHourlyCountryList');
        if (listEl) listEl.innerHTML = '';
        return;
    }
    const hours = payload.hours || [];
    const countries = payload.countries || [];
    const palette = ['#4facfe','#43e97b','#fa709a','#764ba2','#ff9800','#009688','#9c27b0','#03a9f4'];
    const topCountries = countries
        .map(c => ({
            ...c,
            roi_sum: (c.roi || []).reduce((a, b) => a + (Number(b) || 0), 0)
        }))
        .sort((a, b) => b.roi_sum - a.roi_sum)
        .slice(0, 6);
    const datasets = topCountries.map((c, idx) => ({
        label: c.country || c.country_code,
        data: (c.roi || []).map(v => Number(v) || 0),
        borderColor: palette[idx % palette.length],
        backgroundColor: 'transparent',
        borderWidth: 2,
        tension: 0.2
    }));
    window.roiHourlyChart = new Chart(ctx, {
        type: 'line',
        data: { labels: hours.map(h => `${h}:00`), datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            const c = topCountries[context.datasetIndex] || {};
                            const roiVal = context.parsed.y ?? 0;
                            const idx = context.dataIndex;
                            const rev = (c.revenue || [])[idx] ?? 0;
                            const spend = (c.spend || [])[idx] ?? 0;
                            return `${context.dataset.label}: ROI ${roiVal.toFixed(2)}% | Rev ${rev.toLocaleString('id-ID',{style:'currency',currency:'IDR'})} | Spend ${spend.toLocaleString('id-ID',{style:'currency',currency:'IDR'})}`;
                        }
                    }
                }
            },
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { title: { display: true, text: 'Hour (00-23)' } },
                y: {
                    title: { display: true, text: 'ROI (%)' },
                    beginAtZero: true
                }
            }
        }
    });
    canvas.onclick = function(evt) {
        const chart = window.roiHourlyChart;
        if (!chart) return;
        const points = chart.getElementsAtEventForMode(evt, 'index', { intersect: false }, true);
        if (!points || !points.length) return;
        const idx = points[0].index;
        const hourLabel = hours[idx] || '';
        const rows = (countries || []).map(c => {
            const r = Number((c.revenue || [])[idx] ?? 0);
            const s = Number((c.spend || [])[idx] ?? 0);
            const roi = s > 0 ? ((r - s) / s * 100) : 0;
            return { name: c.country || c.country_code, code: c.country_code, roi, r, s };
        });
        window.roiHourlyDetailRows = rows;
        const controlsHtml = '<div id="roiHourlyDetailTableWrapper"></div>';
        openRoiHourlyDetailModal(`Countries at ${hourLabel}:00`, controlsHtml);
    };
    const listEl = document.getElementById('roiHourlyCountryList');
    if (listEl) {
        const items = countries.map(c => {
            const roiSum = (c.roi || []).reduce((a,b)=>a+(Number(b)||0),0);
            return `<span class="badge text-bg-secondary me-1 mb-1">${(c.country||c.country_code)}: ${roiSum.toFixed(1)}%</span>`;
        }).join(' ');
        listEl.innerHTML = items;
    }
}
function openRoiHourlyDetailModal(title, html) {
    const modal = document.getElementById('roiHourlyDetailModal');
    const body = document.getElementById('roiHourlyDetailBody');
    const ttl = document.getElementById('roiHourlyDetailTitle');
    if (!modal || !body || !ttl) return;
    if (modal.parentNode !== document.body) {
        document.body.appendChild(modal);
    }
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.right = '0';
    modal.style.bottom = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.zIndex = '2000';
    ttl.textContent = title || 'Detail';
    body.innerHTML = html || '';
    modal.style.display = 'flex';
    const wrap = document.getElementById('roiHourlyDetailTableWrapper');
    window.roiDetailSort = window.roiDetailSort || { key: 'rev', dir: 'desc', lastKey: null };
    function sortArrow(key) {
        return (window.roiDetailSort && window.roiDetailSort.key === key)
            ? (window.roiDetailSort.dir === 'asc' ? ' ▲' : ' ▼')
            : '';
    }
    function renderRoiHourlyDetail() {
        const rows = Array.isArray(window.roiHourlyDetailRows) ? window.roiHourlyDetailRows.slice() : [];
        let filtered = rows;
        const ss = window.roiDetailSort || { key: 'rev', dir: 'desc', lastKey: null };
        const dir = ss.dir === 'asc' ? 1 : -1;
        function cmp(a,b,key,dir) {
            function num(v){ return Number(v) || 0; }
            if (key === 'rev') {
                const posA = num(a.roi) >= 0 ? 1 : 0;
                const posB = num(b.roi) >= 0 ? 1 : 0;
                if (posA !== posB) return (posB - posA);
                const primary = (num(a.r) - num(b.r));
                if (primary !== 0) return primary * dir;
                const secondary = (num(a.roi) - num(b.roi));
                if (secondary !== 0) return secondary * -1;
                const tertiary = (num(a.s) - num(b.s));
                if (tertiary !== 0) return tertiary * 1;
                return String(a.name||a.code).localeCompare(String(b.name||b.code)) * dir;
            } else if (key === 'roi') {
                const primary = (num(a.roi) - num(b.roi));
                if (primary !== 0) return primary * dir;
                const secondary = (num(a.r) - num(b.r));
                if (secondary !== 0) return secondary * -1;
                const tertiary = (num(a.s) - num(b.s));
                if (tertiary !== 0) return tertiary * 1;
                return String(a.name||a.code).localeCompare(String(b.name||b.code)) * dir;
            } else if (key === 'spend') {
                const secondary = (num(a.r) - num(b.r));
                if (secondary !== 0) return secondary * -1;
                return String(a.name||a.code).localeCompare(String(b.name||b.code)) * dir;
            }
            return String(a.name||a.code).localeCompare(String(b.name||b.code)) * dir;
        }
        filtered.sort((a,b) => cmp(a,b,ss.key,dir));
        const head = ''
            + '<table style="width:100%;border-collapse:collapse;">'
            + '<thead><tr>'
            + '<th class="sortable" data-col="country" style="text-align:left;padding:8px;border-bottom:1px solid #eee;cursor:pointer;">Country' + sortArrow('country') + '</th>'
            + '<th class="sortable" data-col="roi" style="text-align:right;padding:8px;border-bottom:1px solid #eee;cursor:pointer;">ROI (%)' + sortArrow('roi') + '</th>'
            + '<th class="sortable" data-col="rev" style="text-align:right;padding:8px;border-bottom:1px solid #eee;cursor:pointer;">Revenue' + sortArrow('rev') + '</th>'
            + '<th class="sortable" data-col="spend" style="text-align:right;padding:8px;border-bottom:1px solid #eee;cursor:pointer;">Spend' + sortArrow('spend') + '</th>'
            + '</tr></thead>';
        const bodyRows = '<tbody>' + filtered.map(r => {
            const roiStr = (Number(r.roi) || 0).toFixed(2);
            const revStr = Math.round(Number(r.r) || 0).toLocaleString('id-ID');
            const spendStr = Math.round(Number(r.s) || 0).toLocaleString('id-ID');
            return '<tr><td style="padding:8px;border-bottom:1px solid #f5f5f5;">' + (r.name || r.code) + '</td><td style="padding:8px;text-align:right;border-bottom:1px solid #f5f5f5;">' + roiStr + '</td><td style="padding:8px;text-align:right;border-bottom:1px solid #f5f5f5;">Rp ' + revStr + '</td><td style="padding:8px;text-align:right;border-bottom:1px solid #f5f5f5;">Rp ' + spendStr + '</td></tr>';
        }).join('') + '</tbody></table>';
        if (wrap) wrap.innerHTML = head + bodyRows;
    }
    if (wrap && !wrap.dataset.boundSort) {
        wrap.addEventListener('click', function(e) {
            const th = e.target && e.target.closest && e.target.closest('th.sortable');
            if (!th) return;
            const key = th.getAttribute('data-col') || 'roi';
            const cur = window.roiDetailSort || { key: 'rev', dir: 'desc', lastKey: null };
            if (key === 'roi' && cur.lastKey !== 'roi') {
                window.roiDetailSort = { key: 'roi', dir: 'desc', lastKey: 'roi' };
            } else if (cur.key === key) {
                window.roiDetailSort = { key, dir: cur.dir === 'desc' ? 'asc' : 'desc', lastKey: key };
            } else {
                const defaultDir = (key === 'country') ? 'asc' : 'desc';
                window.roiDetailSort = { key, dir: defaultDir, lastKey: key };
            }
            renderRoiHourlyDetail();
        });
        wrap.dataset.boundSort = '1';
    }
    renderRoiHourlyDetail();
}
function closeRoiHourlyDetailModal() {
    const modal = document.getElementById('roiHourlyDetailModal');
    if (!modal) return;
    modal.style.display = 'none';
}
function initRoiHourlyModal() {
    const modal = document.getElementById('roiHourlyDetailModal');
    const btn = document.getElementById('roiHourlyDetailClose');
    if (btn) btn.onclick = closeRoiHourlyDetailModal;
    if (modal) {
        if (modal.parentNode !== document.body) {
            document.body.appendChild(modal);
        }
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.right = '0';
        modal.style.bottom = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.zIndex = '2000';
        modal.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'roiHourlyDetailModal') {
                closeRoiHourlyDetailModal();
            }
        });
    }
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeRoiHourlyDetailModal();
    });
}
// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        showError('Chart.js library is not loaded. Please refresh the page.');
        return;
    }
    // Check if Highcharts is loaded
    if (typeof Highcharts === 'undefined') {
        showError('Highcharts library is not loaded. Please refresh the page.');
        return;
    }
    fetchDashboardData();
    // Auto-refresh every 5 minutes
    setInterval(fetchDashboardData, 5 * 60 * 1000);
    initRoiHourlyModal();
});
</script>
{% endblock %}
