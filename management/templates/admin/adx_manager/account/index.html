{% extends "admin/template_admin.html" %}
{% load static %}
{% block more_stylesheet %}
{% endblock %}
{% block content %}  
{% csrf_token %}
<style>
  .dt-buttons {
      margin-bottom: 20px;
  }
</style>
<div class="card">
    <div class="card-header">
        <h3 class="card-title">AdX Account Data</h3>
    </div> <!-- /.card-header -->
    {% if user.user_name == 'superadmin' %}
    <div class="card-body">
        <div class="form-row">
            <div class="col-md-4">
                <label>Filter Account</label>
                <select class="form-control select2" id="account_filter">
                    <option value="">-- Pilih Akun Terdaftar --</option>
                    {% for account in adx_account_data %}
                    <option value="{{ account.user_id }}">{{ account.user_mail }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label>&nbsp;</label>
                <button type="button" class="btn btn-primary form-control" id="btn_load_data">
                    <i class="fas fa-search"></i> Muat Data
                </button>
            </div>
            <div class="col-md-2">
                <label>&nbsp;</label>
                <button type="button" class="btn btn-info form-control" id="btn_oauth_setup" data-toggle="modal" data-target="#oauthModal">
                    <i class="fas fa-cog"></i> OAuth Setup Credensial
                </button>
            </div>
        </div>
    </div><!-- /.card-body -->
    {% else %}
    <div class="card-body">
        <div class="form-row">
            <div class="col-md-2">
                <label>&nbsp;</label>
                <button type="button" class="btn btn-primary form-control" id="btn_load_data">
                    <i class="fas fa-search"></i> Muat Data
                </button>
            </div>
            <div class="col-md-2">
                <label>&nbsp;</label>
                <button type="button" class="btn btn-info form-control" id="btn_oauth_setup" data-toggle="modal" data-target="#oauthModal">
                    <i class="fas fa-search"></i> OAuth Setup Credensial
                </button>
            </div>
        </div>
    </div><!-- /.card-body -->
    {% endif %}
</div>
<div class="card">
    <div class="card-header">
        <div class="card-title d-flex justify-content-between align-items-center w-100">
            <h3 class="card-title"><b><i class="bi bi-building"></i> AdX Account Information</b></h3>
        </div>
    </div>
    <div class="card-body">
        <div id="overlay" 
            style="
                display: none;
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
                text-align: center;
                color: white;
                font-size: 2rem;
                padding-top: 20%;">
            <i class="fas fa fa-sync-alt fa-spin"></i> Loading Account Data ... 
        </div>
        <!-- Account Info Cards -->
        <div class="row">
            <div class="col-12 col-md-6">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-info-circle"></i> Network Information</h3>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Network ID:</strong></td>
                                <td id="network_id">-</td>
                            </tr>
                            <tr>
                                <td><strong>Network Code:</strong></td>
                                <td id="network_code">-</td>
                            </tr>
                            <tr>
                                <td><strong>Display Name:</strong></td>
                                <td id="display_name">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="card card-outline card-success">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-gear"></i> Settings</h3>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Timezone:</strong></td>
                                <td id="timezone">-</td>
                            </tr>
                            <tr>
                                <td><strong>Currency Code:</strong></td>
                                <td id="currency_code">-</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td><span class="badge badge-success" id="status">Active</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional Account Details -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-list-ul"></i> Account Details</h3>
                    </div>
                    <div class="card-body">
                        <div id="account_details">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5><i class="bi bi-person"></i> User Information</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td><strong>Email:</strong></td>
                                            <td id="user_mail">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>User ID:</strong></td>
                                            <td id="user_id">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>User Name:</strong></td>
                                            <td id="user_name">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Role:</strong></td>
                                            <td id="user_role">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Active:</strong></td>
                                            <td id="user_is_active">-</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5><i class="bi bi-bar-chart"></i> Account Statistics</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td><strong>Active Ad Units:</strong></td>
                                            <td id="active_ad_units_count">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Last Updated:</strong></td>
                                            <td id="last_updated">-</td>
                                        </tr>
                                    </table>
                                    <div id="additional_info" class="mt-3">
                                        <!-- Additional information will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3" id="data_note" style="display: none;">
                                <i class="bi bi-info-circle"></i> <span id="note_text"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OAuth Setup Modal -->
<div class="modal fade" id="oauthModal" tabindex="-1" role="dialog" aria-labelledby="oauthModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="oauthModalLabel">OAuth Setup Credensial</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="oauthForm">
                    <div class="form-group">
                        <label for="client_id">Client ID:</label>
                        <input type="text" class="form-control" id="client_id" name="client_id" placeholder="Enter client ID" required>
                    </div>
                    <div class="form-group">
                        <label for="client_secret">Client Secret:</label>
                        <input type="text" class="form-control" id="client_secret" name="client_secret" placeholder="Enter client secret" required>
                    </div>
                    <div class="form-group">
                        <label for="network_code">Network Code:</label>
                        <input type="text" class="form-control" id="network_code_input" name="network_code" placeholder="Enter network code" required>
                    </div>
                    <div class="form-group">
                        <label for="user_mail">Email Account:</label>
                        <input type="email" class="form-control" id="user_mail_input" name="user_mail" placeholder="Enter email" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                <button type="button" class="btn btn-primary" id="btn_save_oauth"><i class="fa fa-save"></i> Save</button>
            </div>
        </div>
    </div>
</div>

<!-- OAuth Refresh Token Generation Modal -->
<div class="modal fade" id="oauthRefreshTokenModal" tabindex="-1" role="dialog" aria-labelledby="oauthRefreshTokenModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="oauthRefreshTokenModalLabel">
                    <i class="fas fa-key"></i> Generate OAuth Refresh Token
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="oauth-step-1" class="oauth-step">
                    <h6><i class="fas fa-info-circle text-info"></i> Step 1: Generate OAuth URL</h6>
                    <p>Klik tombol di bawah untuk generate OAuth URL yang akan digunakan untuk mendapatkan authorization code.</p>
                    <div class="form-group">
                        <label for="oauth_user_email">Email Account:</label>
                        <input type="email" class="form-control" id="oauth_user_email" name="oauth_user_email" 
                               placeholder="Enter your Google account email" required>
                        <small class="form-text text-muted">Email yang memiliki akses ke Google Ad Manager</small>
                    </div>
                    <button type="button" class="btn btn-primary" id="btn_generate_oauth_url">
                        <i class="fas fa-link"></i> Generate OAuth URL
                    </button>
                    <div id="oauth_url_result" class="mt-3" style="display: none;">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> OAuth URL Generated!</h6>
                            <p>Klik link di bawah untuk melakukan authorization:</p>
                            <a id="oauth_authorization_link" href="#" target="_blank" class="btn btn-success btn-sm">
                                <i class="fas fa-external-link-alt"></i> Open Authorization Page
                            </a>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Instruksi:</strong><br>
                                    1. Klik link di atas untuk membuka halaman authorization Google<br>
                                    2. Login dengan akun Google yang memiliki akses Ad Manager<br>
                                    3. Berikan izin yang diminta<br>
                                    4. Copy authorization code yang diberikan<br>
                                    5. Paste code tersebut di Step 2 di bawah
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="oauth-step-2" class="oauth-step mt-4" style="display: none;">
                    <h6><i class="fas fa-code text-warning"></i> Step 2: Submit Authorization Code</h6>
                    <p>Paste authorization code yang didapat dari Google di sini:</p>
                    <div class="form-group">
                        <label for="authorization_code">Authorization Code:</label>
                        <textarea class="form-control" id="authorization_code" name="authorization_code" 
                                  rows="3" placeholder="Paste authorization code here..." required></textarea>
                    </div>
                    <button type="button" class="btn btn-success" id="btn_submit_auth_code">
                        <i class="fas fa-check"></i> Submit & Generate Refresh Token
                    </button>
                </div>
                
                <div id="oauth_generation_result" class="mt-3" style="display: none;">
                    <!-- Result will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block more_scripts %}
<script src="{% static 'ajax/admin/adx_manager/account.js'%}?v={%now 'u'%}"></script>
{% endblock %}