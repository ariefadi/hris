{% extends 'admin_base.html' %}

{% block page_title %}Master Server{% endblock %}
{% block page_heading %}Master Server{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">Projects</li>
<li class="breadcrumb-item active"><a href="/projects/master/server">Master Server</a></li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Daftar Server</h3>
        <div class="card-tools">
          <a href="#" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modalCreateServer">
            <i class="bi bi-plus-circle"></i> Tambah Server
          </a>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th width="5%">No</th>
                <th width="20%">Hostname</th>
                <th width="15%">Label</th>
                <th width="10%">Region</th>
                <th width="10%">Status</th>
                <th width="15%">IPv4</th>
                <th width="10%">Expires</th>
                <th width="15%">Aksi</th>
              </tr>
            </thead>
            <tbody>
              {% for s in servers %}
              <tr>
                <td class="align-middle">{{ forloop.counter }}</td>
                <td class="align-middle">{{ s.hostname }}</td>
                <td class="align-middle">{{ s.label }}</td>
                <td class="align-middle">{{ s.region }}</td>
                <td class="align-middle">{{ s.server_status|title }}</td>
                <td class="align-middle">{{ s.public_ipv4 }}</td>
                <td class="align-middle">{% if s.expires_at %}{{ s.expires_at|date:'Y-m-d' }}{% endif %}</td>
                <td class="align-middle">
                  <a href="/projects/master/server/{{ s.server_id }}/edit" class="btn btn-sm btn-warning"><i class="bi bi-pencil"></i></a>
                  <form action="/projects/master/server/{{ s.server_id }}/delete" method="post" style="display:inline-block;margin-left:6px;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Hapus server ini?')"><i class="bi bi-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted">Belum ada data server.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Create Server -->
<div class="modal fade" id="modalCreateServer" tabindex="-1" role="dialog" aria-labelledby="modalCreateServerLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCreateServerLabel">Tambah Server</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="formCreateServer" method="post">
        <div class="modal-body">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Hostname <span class="text-danger">*</span></label>
              <input type="text" name="hostname" class="form-control" required>
            </div>
            <div class="form-group col-md-3">
              <label>Label <span class="text-danger">*</span></label>
              <input type="text" name="label" class="form-control" required>
            </div>
            <div class="form-group col-md-3">
              <label>Provider <span class="text-danger">*</span></label>
              <select name="provider" class="form-control select2" id="provider_select" data-placeholder="-- Pilih Provider --" required>
                <option value=""></option>
                {% for p in providers %}
                  <option value="{{ p.provider }}">{{ p.provider }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Region</label>
              <input type="text" name="region" class="form-control">
            </div>
            <div class="form-group col-md-3">
              <label>Location</label>
              <input type="text" name="location" class="form-control">
            </div>
            <div class="form-group col-md-3">
              <label>Server Code</label>
              <input type="text" name="server_code" class="form-control">
            </div>
            <div class="form-group col-md-3">
              <label>Server Name</label>
              <input type="text" name="server_name" class="form-control">
            </div>
            <div class="form-group col-md-3">
              <label>Status <span class="text-danger">*</span></label>
              <select name="server_status" class="form-control" required>
                {% for st in statuses %}
                  <option value="{{ st }}">{{ st|title }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>OS Name <span class="text-danger">*</span></label>
              <input type="text" name="os_name" class="form-control" required>
            </div>
            <div class="form-group col-md-3">
              <label>OS Version</label>
              <input type="text" name="os_version" class="form-control">
            </div>
            <div class="form-group col-md-3">
              <label>Arch</label>
              <select name="arch" class="form-control">
                {% for a in archs %}
                  <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>vCPU <span class="text-danger">*</span></label>
              <input type="number" name="vcpu_count" class="form-control" min="1" required>
            </div>
            <div class="form-group col-md-3">
              <label>Memory (GB) <span class="text-danger">*</span></label>
              <input type="number" name="memory_gb" class="form-control" min="1" required>
            </div>
            <div class="form-group col-md-3">
              <label>Swap (MB)</label>
              <input type="number" name="swap_mb" class="form-control" min="0">
            </div>
            <div class="form-group col-md-3">
              <label>Disk (GB) <span class="text-danger">*</span></label>
              <input type="number" step="0.01" name="disk_gb" class="form-control" min="1" required>
            </div>
            <div class="form-group col-md-3">
              <label>Disk Type</label>
              <select name="disk_type" class="form-control">
                {% for t in disk_types %}
                  <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Bandwidth (TB)</label>
              <input type="number" step="0.01" name="bandwidth_tb" class="form-control" min="0">
            </div>
            <div class="form-group col-md-3">
              <label>Network Speed (Mbps)</label>
              <input type="number" name="network_speed_mbps" class="form-control" min="0">
            </div>
            <div class="form-group col-md-3">
              <label>Public IPv4 <span class="text-danger">*</span></label>
              <input type="text" name="public_ipv4" class="form-control" required>
            </div>
            <div class="form-group col-md-3">
              <label>Public IPv6</label>
              <input type="text" name="public_ipv6" class="form-control">
            </div>
            <div class="form-group col-md-3">
              <label>Private IPv4</label>
              <input type="text" name="private_ipv4" class="form-control">
            </div>
            <div class="form-group col-md-3">
              <label>Private IPv6 <span class="text-danger">*</span></label>
              <input type="text" name="private_ipv6" class="form-control" required>
            </div>
            <div class="form-group col-md-3">
              <label>SSH Port <span class="text-danger">*</span></label>
              <input type="number" name="ssh_port" class="form-control" value="22" min="1" required>
            </div>
            <div class="form-group col-md-3">
              <label>SSH User <span class="text-danger">*</span></label>
              <input type="text" name="ssh_user" class="form-control" required>
            </div>
            <div class="form-group col-md-3">
              <label>SSH Fingerprint</label>
              <input type="text" name="ssh_fingerprint" class="form-control">
            </div>
            <div class="form-group col-md-6">
              <label>SSH Keys (comma separated)</label>
              <textarea name="ssh_keys" class="form-control" placeholder="ssh-rsa AAA..., ssh-ed25519 AAA..."></textarea>
            </div>
            <div class="form-group col-md-3">
              <label>SSH Password</label>
              <input type="text" name="ssh_pass" class="form-control">
            </div>
            <div class="form-group col-md-3">
              <label>Cost Monthly</label>
              <input type="number" step="0.01" name="cost_monthly" class="form-control" min="0">
            </div>
            <div class="form-group col-md-3">
              <label>Currency</label>
              <select name="currency" class="form-control">
                {% for c in currencies %}
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Conversion to IDR</label>
              <input type="number" step="0.01" name="currency_conversion_idr" class="form-control" min="0">
            </div>
            <div class="form-group col-md-3">
              <label>Tanggal Berlaku</label>
              <input type="text" name="purchased_at" class="form-control datepicker-input">
            </div>
            <div class="form-group col-md-3">
              <label>Tanggal Kadaluarsa <span class="text-danger">*</span></label>
              <input type="text" name="expires_at" class="form-control datepicker-input" required>
            </div>
            <div class="form-group col-md-12">
              <label>Notes</label>
              <textarea name="notes" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary" id="btn_submit_server">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block more_scripts %}
<script>
$(function(){
  if (window.jQuery && $.fn.select2) {
    $('#provider_select').select2({
      theme: 'bootstrap4',
      dropdownParent: $('#modalCreateServer'),
      allowClear: true,
      placeholder: $('#provider_select').data('placeholder') || '-- Pilih Provider --'
    });
  }
  if (window.jQuery && $.fn.datepicker) {
    $('.datepicker-input').datepicker({
      format: 'yyyy-mm-dd',
      autoclose: true,
      todayHighlight: true
    });
  }
  $('#formCreateServer').on('submit', function(e){
    e.preventDefault();
    var $btn = $('#btn_submit_server');
    $btn.prop('disabled', true);
    var formData = $(this).serialize();
    $.ajax({
      url: '/projects/master/server/create',
      method: 'POST',
      data: formData,
      dataType: 'json',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(resp){
        var ok = resp && (resp.status === true || resp.status === 'True');
        if (ok) {
          if (window.Swal) {
            Swal.fire({icon: 'success', title: 'Berhasil', text: 'Server ditambahkan'}).then(function(){
              window.location.reload();
            });
          } else {
            window.location.reload();
          }
        } else {
          var emsg = (resp && resp.message) ? resp.message : 'Gagal menyimpan server';
          if (window.Swal) {
            Swal.fire({icon: 'error', title: 'Gagal', text: emsg});
          } else {
            alert(emsg);
          }
          $btn.prop('disabled', false);
        }
      },
      error: function(xhr){
        var emsg = (xhr && xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : 'Terjadi kesalahan saat menyimpan';
        if (window.Swal) {
          Swal.fire({icon: 'error', title: 'Gagal', text: emsg});
        } else {
          alert(emsg);
        }
      },
      complete: function(){
        $btn.prop('disabled', false);
      }
    });
  });
});
</script>
{% endblock %}
