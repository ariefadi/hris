{% extends 'admin_base.html' %}

{% block page_title %}Edit Niche{% endblock %}
{% block page_heading %}Edit Niche{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">Projects</li>
<li class="breadcrumb-item"><a href="/projects/master/niche">Master Niche</a></li>
<li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Edit Niche</h3>
      </div>
      <div class="card-body">
        <form id="formEditNiche" method="post" action="{% url 'projects_master_niche_update' niche.niche_id %}">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Niche</label>
              <input type="text" name="niche" class="form-control" value="{{ niche.niche }}" required>
            </div>
            <div class="form-group col-md-6">
              <label>Keyword CPC</label>
              <input type="number" name="keyword_cpc" class="form-control" min="0" value="{{ niche.keyword_cpc }}">
            </div>
            <div class="form-group col-md-12">
              <label>Focuses</label>
              <textarea name="focuses" class="form-control" rows="2">{{ niche.focuses }}</textarea>
            </div>
            <div class="form-group col-md-12">
              <label>Country List</label>
              <select name="country_list" id="country_list_edit" class="form-control select2-countries" multiple>
                {% for c in countries %}
                  <option value="{{ c.negara_nm }}" {% if c.negara_nm in selected_countries %}selected{% endif %}>{{ c.negara_nm }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-12">
              <label>Keywords</label>
              <textarea name="keywords" class="form-control" rows="3">{{ niche.keywords }}</textarea>
            </div>
            <div class="form-group col-md-4">
              <label>Status</label>
              <select name="status" class="form-control">
                {% for st in statuses %}
                  <option value="{{ st }}" {% if niche.status == st %}selected{% endif %}>{{ st|title }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-primary" id="btn_submit_niche">Simpan</button>
            <a href="{% url 'projects_master_niche' %}" class="btn btn-secondary">Batal</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block more_scripts %}
<script>
$(function(){
  if (window.jQuery && $.fn.select2) {
    $('#country_list_edit').select2({
      theme: 'bootstrap4',
      tags: true
    });
  }
  $(document).on('select2:open', function(e){
    var $sel = $(e.target);
    if (!$sel.is('select.select2-countries')) return;
    var field = document.querySelector('.select2-container--open .select2-search__field');
    if (!field) return;
    if (field._pasteBound) return;
    field._pasteBound = true;
    field.addEventListener('paste', function(ev){
      var txt = '';
      try { txt = (ev.clipboardData && ev.clipboardData.getData('text')) || ''; } catch(x){}
      if (!txt && window.clipboardData) { try { txt = window.clipboardData.getData('Text') || ''; } catch(e){} }
      if (!txt) return;
      ev.preventDefault();
      var parts = txt.split(/[\s]*,[\s]*|\n|;+/).map(function(s){ return (s||'').trim(); }).filter(function(s){ return !!s; });
      if (!parts.length) return;
      var matches = [];
      $sel.find('option').each(function(){
        var val = (this.value||'').trim().toLowerCase();
        var txt2 = ($(this).text()||'').trim().toLowerCase();
        for (var i=0;i<parts.length;i++){
          var p = parts[i].toLowerCase();
          if (val === p || txt2 === p) { matches.push(this.value); break; }
        }
      });
      var existing = $sel.val() || [];
      var combined = Array.from(new Set(existing.concat(matches)));
      $sel.val(combined).trigger('change');
    });
  });
  $('#formEditniche').on('submit', function(e){
    e.preventDefault();
    var $btn = $('#btn_submit_niche');
    $btn.prop('disabled', true);
    var formData = $(this).serialize();
    $.ajax({
      url: $(this).attr('action'),
      method: 'POST',
      data: formData,
      dataType: 'json',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(resp){
        var ok = resp && (resp.status === true || resp.status === 'True');
        if (ok) {
          if (window.Swal) {
            Swal.fire({icon: 'success', title: 'Berhasil', text: 'Niche diperbarui', timer: 1000, showConfirmButton: false}).then(function(){ window.location.href = '{% url 'projects_master_niche' %}'; });
          } else {
            window.location.href = '{% url 'projects_master_niche' %}';
          }
        } else {
          var emsg = (resp && resp.message) ? resp.message : 'Gagal menyimpan';
          if (window.Swal) {
            Swal.fire({icon: 'error', title: 'Gagal', text: emsg});
          } else {
            alert(emsg);
          }
          $btn.prop('disabled', false);
        }
      },
      error: function(xhr){
        var emsg = (xhr && xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : 'Terjadi kesalahan saat menyimpan';
        if (window.Swal) {
          Swal.fire({icon: 'error', title: 'Gagal', text: emsg});
        } else {
          alert(emsg);
        }
      },
      complete: function(){
        $btn.prop('disabled', false);
      }
    });
  });
});
</script>
{% endblock %}
