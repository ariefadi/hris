{% extends 'admin_base.html' %}

{% block page_title %}Technical{% endblock %}
{% block page_heading %}Technical{% endblock %}

{% block more_stylesheet %}
<style>
.technical-page .card { border-radius: 14px; }
.technical-page .partner-card { border: 1px solid rgba(0,0,0,0.06); box-shadow: 0 8px 24px rgba(0,0,0,0.06); }
.technical-page .partner-card .card-header { background: linear-gradient(135deg, rgba(23,162,184,0.12), rgba(23,162,184,0.02)); border-bottom: 1px solid rgba(0,0,0,0.06); }
.technical-page .partner-title { font-weight: 700; }
.technical-page .partner-meta { display: flex; flex-wrap: wrap; gap: 8px; }
.technical-page .meta-badge { background: #f8f9fa; border: 1px solid rgba(0,0,0,0.06); color: #495057; padding: 4px 8px; border-radius: 999px; font-size: 0.75rem; }
.technical-page .subdomain-card { border: 1px solid rgba(0,0,0,0.06); box-shadow: 0 6px 16px rgba(0,0,0,0.05); }
.technical-page .subdomain-card .card-body { padding: 16px; }
.technical-page .section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; color: #6c757d; }
.technical-page .info-pill { background: #eef6ff; color: #1f4b88; border-radius: 8px; padding: 6px 10px; font-weight: 600; }
.technical-page .info-muted { color: #6c757d; }
.technical-page .action-group .btn { margin-left: 4px; }
.technical-page .action-group .btn:first-child { margin-left: 0; }
@media (max-width: 991px) {
  .technical-page .partner-header-actions { margin-top: 10px; }
}
</style>
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">Task</li>
<li class="breadcrumb-item active"><a href="/projects/task/technical">Technical</a></li>
{% endblock %}

{% block content %}

<div class="row technical-page">
  <div class="col-12">
    
    {% for p in partners %}
    <div class="col-12">
      <div class="card partner-card card-outline card-info">
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="h5 mb-2 partner-title">{{ p.partner_name }}</div>
              <div class="partner-meta">
                {% if p.request_date %}<span class="meta-badge">Request {{ p.request_date|date:'d M Y' }}</span>{% endif %}
                <span class="meta-badge">PIC {{ p.pic|default:"-" }}</span>
                {% if p.domain %}<span class="meta-badge">{{ p.domain }}</span>{% endif %}
              </div>
            </div>
            <div class="partner-header-actions">
              <a href="#" class="btn btn-sm btn-success btn-send" data-partner-id="{{ p.partner_id }}" data-process-id="{{ p.process_id }}" title="Kirim"><i class="bi bi-send"></i> Kirim</a>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            {% for s in p.subrows %}
            <div class="col-12 col-lg-6">
              <div class="card subdomain-card h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="info-pill" style="word-break: break-word;">Server: {{ s.public_ipv4|default:"-" }}</div>
                    <div class="text-right">
                      <div class="section-title">Cloudflare</div>
                      <div class="info-muted" style="word-break: break-word;">{{ s.cloudflare|default:"-" }}</div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="section-title">Website Login</div>
                      <div class="info-muted mb-2" style="word-break: break-word;">
                        {{ s.website|default:"-" }}<br>
                        User: {{ s.website_user|default:"-" }}<br>
                        Pass: {{ s.website_pass|default:"-" }}
                      </div>
                      <div class="action-group">
                        <a href="#" class="btn btn-xs btn-soft btn-warning btn-edit-subrow" data-partner-id="{{ p.partner_id }}" data-subdomain-id="{{ s.subdomain_id }}" title="Edit Server"><i class="bi bi-pencil"></i> Edit Server</a>
                        <a href="#" class="btn btn-xs btn-soft btn-danger btn-delete-subrow" data-partner-id="{{ p.partner_id }}" data-subdomain-id="{{ s.subdomain_id }}" title="Hapus Server"><i class="bi bi-trash"></i> Hapus Server</a>
                      </div>
                    </div>
                    <div class="col-md-6 text-right" data-niche-cell="1" data-subdomain-id="{{ s.subdomain_id }}">
                      <div class="section-title">Niche & Keywords</div>
                      <div class="info-muted mb-2">
                        <div><b>Niche:</b> <span class="nk-niche-name">-</span></div>
                        <div><b>Keywords:</b> <span class="nk-keyword-total">-</span></div>
                      </div>
                      <div class="section-title">Deadline</div>
                      <input type="date" class="form-control mb-2" name="article_deadline">
                      <div class="action-group">
                        <a href="#" class="btn btn-xs btn-primary btn-add-nk" data-subdomain-id="{{ s.subdomain_id }}"><i class="bi bi-plus"></i> Tambah Niche</a>
                        <a href="#" class="btn btn-xs btn-warning btn-edit-nk" data-subdomain-id="{{ s.subdomain_id }}"><i class="bi bi-pencil"></i> Edit Niche</a>
                        <a href="#" class="btn btn-xs btn-danger btn-delete-nk" data-subdomain-id="{{ s.subdomain_id }}"><i class="bi bi-trash"></i> Hapus Niche</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="col-12">
              <div class="text-center text-muted py-3">Belum ada subdomain.</div>
            </div>
            {% endfor %}
          </div>
          <div class="text-center mt-3">
            <button class="btn btn-sm btn-primary" id="add_edit_server_{{ p.partner_id }}"><i class="bi bi-plus"></i> Tambah / Pilih Data Server</button>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="text-center text-muted py-4">Belum ada data waiting.</div>
        </div>
      </div>
    </div>
    {% endfor %}
 </div>
</div>

<div class="modal fade" id="modalAddNicheKeyword" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tambah / Edit Niche & Keyword</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="modal_subdomain_id" value="">
        <input type="hidden" id="modal_action" value="">
        {% csrf_token %}
        <div class="form-group">
          <label>Niche</label>
          <select id="modal_niche_id" class="form-control select2" data-placeholder="-- Pilih Niche --">
            <option value=""></option>
            {% for n in niches %}
              <option value="{{ n.niche_id }}">{{ n.niche }}</option>
            {% endfor %}
          </select>
        </div>
        <template id="nk_group_template">
          <div class="nk-group border p-3">
            <div class="form-group">
              <label>Keyword</label>
              <select class="form-control select2 keyword-select" name="keyword[]" multiple data-placeholder="-- Pilih Keyword --"></select>
            </div>
            <div class="form-group">
              <label>Prompt</label>
              <select class="form-control select2" name="prompt_id[]" data-placeholder="-- Pilih Prompt --">
                <option value=""></option>
                {% for p in prompts %}
                  <option value="{{ p.prompt_id }}">{{ p.prompt }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label>Status</label>
              <select class="form-control select2" name="status[]" data-placeholder="-- Pilih Status --">
                <option value="draft">draft</option>
                <option value="posted">posted</option>
                <option value="indexed">indexed</option>
              </select>
            </div>
            <button type="button" class="btn btn-sm btn-danger btn-del-group"><i class="bi bi-trash"></i> Hapus</button>
          </div>
        </template>
        <div id="nk_groups"></div>
        <div class="mt-2">
          <button type="button" class="btn btn-sm btn-secondary btn-add-group"><i class="bi bi-plus"></i> Tambah Keyword</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
        <button type="button" class="btn btn-primary btn-save-nk">Simpan</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modalAddEditServer" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tambah / Pilih Data Server</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="modal_partner_id" value="">
        <input type="hidden" id="modal_domain_name" value="">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-6">
            <label>Server IP</label>
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="lookup_ip" placeholder="IP Server" required>
              <div class="input-group-append">
                <button type="button" class="btn btn-outline-primary" id="btn_check_ip">Cek</button>
              </div>
            </div>
            <b class="result-text"></b>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-12">
            <h6>Data Server</h6>
          </div>
          <div class="col-md-4">
            <label>Hostname</label>
            <input type="text" class="form-control" id="srv_hostname" placeholder="serverChipichip" required>
          </div>
          <div class="col-md-4">
            <label>Label</label>
            <input type="text" class="form-control" id="srv_label" placeholder="chipichips" required>
          </div>
          <div class="col-md-4">
            <label>Provider</label>
            <select class="form-control select2" id="srv_provider" data-placeholder="-- Pilih Provider --" required>
              <option value=""></option>
              {% for p in providers %}
                <option value="{{ p.provider }}">{{ p.provider }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4 mt-2">
            <label>vCPU</label>
            <input type="number" min="1" class="form-control" id="srv_vcpu_count" placeholder="cth: 8" required>
          </div>
          <div class="col-md-4 mt-2">
            <label>Memory (GB)</label>
            <input type="number" min="1" class="form-control" id="srv_memory_gb" placeholder="Memory / RAM" required>
          </div>
          <div class="col-md-4 mt-2">
            <label>IP Publik</label>
            <input type="text" class="form-control" id="srv_public_ipv4" placeholder="IP Publik" required>
          </div>
          <div class="col-md-4 mt-2">
            <label>SSH User</label>
            <input type="text" class="form-control" id="srv_ssh_user" placeholder="ssh user" required>
          </div>
          <div class="col-md-4 mt-2">
            <label>SSH Pass</label>
            <input type="text" class="form-control" id="srv_ssh_pass" placeholder="ssh pass">
          </div>
          <div class="col-md-4 mt-2">
            <label>SSH Keys</label>
            <textarea class="form-control" id="srv_ssh_keys" rows="2" placeholder="ssh keys"></textarea>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-12">
            <h6>Data Subdomain & Website</h6>
          </div>
          <div class="col-12" id="sdws_rows_container"></div>
          <div class="col-12 mt-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="btn_add_sdws_row"><i class="bi bi-plus"></i> Tambah Subdomain</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
        <button type="button" class="btn btn-primary" id="btn_save_server">Simpan</button>
      </div>
    </div>
  </div>
 </div>

<script>
(function(){
  var lastPartnerDomains = [];
  var currentDomainName = '';
  function showModal(){
    var m = document.getElementById('modalAddEditServer');
    if (window.jQuery && $('#modalAddEditServer').modal) { $('#modalAddEditServer').modal('show'); return; }
    if (!m) return;
    m.classList.add('show');
    m.style.display = 'block';
    m.setAttribute('aria-modal','true');
    m.removeAttribute('aria-hidden');
    var bd = document.createElement('div');
    bd.className = 'modal-backdrop fade show';
    bd.id = 'modal-backdrop-addedit';
    document.body.appendChild(bd);
  }
  function hideModal(){
    var m = document.getElementById('modalAddEditServer');
    if (window.jQuery && $('#modalAddEditServer').modal) { $('#modalAddEditServer').modal('hide'); return; }
    if (!m) return;
    m.classList.remove('show');
    m.style.display = 'none';
    m.setAttribute('aria-hidden','true');
    var bd = document.getElementById('modal-backdrop-addedit');
    if (bd) bd.remove();
  }
  document.addEventListener('click', function(e){
    if (e.target.matches('#modalAddEditServer .close') || e.target.matches('#modalAddEditServer [data-dismiss="modal"]')) {
      hideModal();
    }
  });
  document.querySelectorAll('button[id^=add_edit_server_]').forEach(function(btn){
    btn.addEventListener('click', function(){
      document.getElementById('btn_add_sdws_row').style.display = 'block';
      var pid = this.id.replace('add_edit_server_', '');
      var hidden = document.getElementById('modal_partner_id');
      if (hidden) hidden.value = pid;
      var modalEl = document.getElementById('modalAddEditServer');
      if (modalEl) modalEl.dataset.mode = 'add';
      ['lookup_ip','srv_public_ipv4','srv_hostname','srv_label','srv_vcpu_count','srv_memory_gb','srv_ssh_user','srv_ssh_pass','srv_ssh_keys'].forEach(function(id){ var el=document.getElementById(id); if(el){ el.value=''; el.classList.remove('is-invalid'); }});
      var rt = document.querySelector('.result-text'); if (rt){ rt.textContent=''; rt.classList.remove('text-danger','text-success'); }
      var cont = document.getElementById('sdws_rows_container');
      if (cont) { cont.innerHTML=''; }
      showModal();
      // add mode: fetch partner domains and store first domain
      // fetch partner domains only
      var url = '{% url "projects_task_technical_partner_domains" %}' + '?partner_id=' + encodeURIComponent(pid);
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(function(r){ return r.json(); })
        .then(function(resp){
          var ds = resp.domains || [];
          lastPartnerDomains = ds;
          var mdid = document.getElementById('modal_domain_id');
          var mdn = document.getElementById('modal_domain_name');
          if (ds.length){
            currentDomainName = ds[0].domain || '';
            if (mdid) mdid.value = ds[0].domain_id;
            if (mdn) mdn.value = currentDomainName;
          } else {
            currentDomainName = '';
            if (mdid) mdid.value = '';
            if (mdn) mdn.value = '';
          }
        });
    });
  });
  function setValues(resp, ip){
    var srv = resp && resp.server ? resp.server : {};
    var el;
    el = document.getElementById('lookup_ip'); if (el) el.value = srv.public_ipv4 || ip || '';
    el = document.getElementById('srv_public_ipv4'); if (el) el.value = srv.public_ipv4 || ip || '';
    el = document.getElementById('srv_hostname'); if (el) el.value = srv.hostname || '';
    el = document.getElementById('srv_label'); if (el) el.value = srv.label || '';
    el = document.getElementById('srv_provider'); if (el) { el.value = srv.provider || ''; if (window.jQuery && $.fn.select2) { $('#srv_provider').val(srv.provider || '').trigger('change'); } }
    el = document.getElementById('srv_vcpu_count'); if (el) el.value = srv.vcpu_count || '';
    el = document.getElementById('srv_memory_gb'); if (el) el.value = srv.memory_gb || '';
    el = document.getElementById('srv_ssh_user'); if (el) el.value = srv.ssh_user || '';
    el = document.getElementById('srv_ssh_pass'); if (el) el.value = srv.ssh_pass || '';
    el = document.getElementById('srv_ssh_keys'); if (el) el.value = srv.ssh_keys || '';
  }
  function domainNameFrom(resp, domainId){
    var ds = resp && resp.domains ? resp.domains : [];
    var name = '';
    if (domainId && ds && ds.length){
      for (var i=0;i<ds.length;i++){ if (String(ds[i].domain_id) === String(domainId)) { name = ds[i].domain; break; } }
    }
    if (!name && ds && ds.length){ name = ds[0].domain; }
    return name;
  }
  function appendSdwsRow(defaults){
    var c = document.getElementById('sdws_rows_container');
    if (!c) return;
    var sub = defaults && defaults.subdomain ? defaults.subdomain : '';
    var cf = defaults && defaults.cloudflare ? defaults.cloudflare : '';
    var ip = defaults && defaults.public_ipv4 ? defaults.public_ipv4 : '';
    var web = defaults && defaults.website ? defaults.website : '';
    var wuser = defaults && defaults.website_user ? defaults.website_user : '';
    var wpass = defaults && defaults.website_pass ? defaults.website_pass : '';
    var dname = defaults && defaults.domain_name ? defaults.domain_name : '';
    var html = ''+
      '<div class="sdws-row border p-2 mb-2">'+
      '  <div class="row">'+
      '    <div class="col-md-4">'+
      '      <label>Subdomain</label>'+
      '      <div class="input-group mb-3">'+
      '        <input type="text" class="form-control" name="sd_subdomain" placeholder="subdomain" value="'+ (sub || '') +'" required>'+
      '        <span class="input-group-text domain-text">'+ (dname ? ('.'+dname) : '.example.com') +'</span>'+
      '      </div>'+
      '    </div>'+
      '    <div class="col-md-4">'+
      '      <label>Akun Cloudflare</label>'+
      '      <input type="text" class="form-control" name="sd_cloudflare" placeholder="cloudflare" value="'+ (cf || '') +'" required>'+
      '    </div>'+
      '    <div class="col-md-4">'+
      '      <label>IP Server</label>'+
      '      <input type="text" class="form-control ip-field" name="sd_public_ipv4" placeholder="IP Server" value="'+ (ip || '') +'" required>'+
      '    </div>'+
      '    <div class="col-md-4">'+
      '      <label>Website</label>'+
      '      <input type="text" class="form-control" name="ws_website" placeholder="https://..." value="'+ (web || '') +'" required>'+
      '    </div>'+
      '    <div class="col-md-4">'+
      '      <label>Website User</label>'+
      '      <input type="text" class="form-control" name="ws_website_user" placeholder="user" value="'+ (wuser || '') +'" required>'+
      '    </div>'+
      '    <div class="col-md-4">'+
      '      <label>Website Pass</label>'+
      '      <input type="text" class="form-control" name="ws_website_pass" placeholder="pass" value="'+ (wpass || '') +'" required>'+
      '    </div>'+
      '    <div class="col-12 mt-2">'+
      '      <button type="button" class="btn btn-sm btn-outline-danger btn-del-sdws">Hapus Baris</button>'+
      '    </div>'+
      '  </div>'+
      '</div>';
    var div = document.createElement('div');
    div.innerHTML = html;
    var rowEl = div.firstChild;
    c.appendChild(rowEl);
    rowEl.querySelector('.btn-del-sdws').addEventListener('click', function(){ rowEl.remove(); });
    var subInput = rowEl.querySelector('input[name=sd_subdomain]');
    var webInput = rowEl.querySelector('input[name=ws_website]');
    var domainEl = rowEl.querySelector('.domain-text');
    function updateWebsiteFromSub(){
      if (!subInput || !webInput || !domainEl) return;
      var sub = (subInput.value || '').trim();
      var dom = (domainEl.textContent || '').trim().replace(/^\./, '');
      var url = '';
      if (sub && dom) { url = 'https://' + sub + '.' + dom; }
      webInput.value = url;
    }
    if (subInput) { subInput.addEventListener('change', updateWebsiteFromSub); }
    if (webInput && !(webInput.value || '').trim()) { updateWebsiteFromSub(); }
  }
  function renderSdwsRows(resp, ip){
    var c = document.getElementById('sdws_rows_container');
    if (!c) return;
    c.innerHTML = '';
    var list = resp && resp.subrows ? resp.subrows : [];
    if (list && list.length){
      list.forEach(function(item){
        var dname = domainNameFrom(resp, item.domain_id);
        appendSdwsRow({
          subdomain: item.subdomain,
          cloudflare: item.cloudflare,
          public_ipv4: item.public_ipv4,
          website: item.website,
          website_user: item.website_user,
          website_pass: item.website_pass,
          domain_name: dname
        });
      });
    } else {
      var dname = domainNameFrom(resp, (resp && resp.selected_domain_id) ? resp.selected_domain_id : null);
      appendSdwsRow({ public_ipv4: ip || (document.getElementById('srv_public_ipv4').value || ''), domain_name: dname });
    }
  }
  var btnCheck = document.getElementById('btn_check_ip');
  if (btnCheck) {
    btnCheck.addEventListener('click', function(){
      var ip = (document.getElementById('lookup_ip').value || '').trim();
      var pid = document.getElementById('modal_partner_id').value;
      if (!ip) return;
      var url = '{% url "projects_task_technical_server_lookup" %}' + '?ip=' + encodeURIComponent(ip) + '&partner_id=' + encodeURIComponent(pid);
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(function(r){ return r.json(); })
        .then(function(resp){
          setValues(resp, ip);
          var rt = document.querySelector('.result-text');
          if (rt){
            rt.classList.remove('text-danger','text-success');
            if (resp && resp.server){
              rt.textContent = 'Data server ditemukan.';
              rt.classList.add('text-success');
            } else {
              rt.textContent = 'Data server tidak ditemukan, silahkan lengkapi form di bawah.';
              rt.classList.add('text-danger');
            }
          }
        });
    });
  }
  if (window.jQuery && $.fn.select2) {
    $('#srv_provider').select2({
      theme: 'bootstrap4',
      dropdownParent: $('#modalAddEditServer'),
      allowClear: true,
      placeholder: $('#srv_provider').data('placeholder') || '-- Pilih Provider --'
    });
  }
  function syncSubdomainIP(){
    var ip = (document.getElementById('srv_public_ipv4').value || '').trim();
    if (ip) { var s = document.getElementById('sd_public_ipv4'); if (s) s.value = ip; }
  }
  var ipInput = document.getElementById('srv_public_ipv4');
  if (ipInput) {
    ['input','change','keyup'].forEach(function(ev){ ipInput.addEventListener(ev, syncSubdomainIP); });
  }
  var btnSave = document.getElementById('btn_save_server');
  if (btnSave) {
    btnSave.addEventListener('click', function(){
      var pid = document.getElementById('modal_partner_id').value;
      var form = new FormData();
      form.append('partner_id', pid);
      var modeEl = document.getElementById('modalAddEditServer');
      var isAddMode = modeEl && modeEl.dataset && modeEl.dataset.mode === 'add';
      if (isAddMode) {
        var mdid = document.getElementById('modal_domain_id');
        var did = mdid ? (mdid.value || '') : '';
        if (!did) {
          var ds = (typeof lastPartnerDomains !== 'undefined' && lastPartnerDomains) ? lastPartnerDomains : [];
          if (ds.length) { did = ds[0].domain_id; }
        }
        if (!did) { alert('Domain untuk partner tidak tersedia'); return; }
        form.append('domain_id', did);
      }
      var requiredFilled = true;
      var modal = document.getElementById('modalAddEditServer');
      if (modal){
        var reqs = modal.querySelectorAll('[required]');
        reqs.forEach(function(el){
          var v = (el.value || '').trim();
          if (!v){ requiredFilled = false; el.classList.add('is-invalid'); } else { el.classList.remove('is-invalid'); }
        });
      }
      if (!requiredFilled) { alert('Lengkapi semua field yang wajib diisi.'); return; }
      var hiddenSid = document.getElementById('modal_subdomain_id');
      if (!isAddMode && hiddenSid) { form.append('subdomain_id', hiddenSid.value || ''); }
      form.append('srv_hostname', document.getElementById('srv_hostname').value || '');
      form.append('srv_label', document.getElementById('srv_label').value || '');
      form.append('srv_provider', document.getElementById('srv_provider').value || '');
      form.append('srv_vcpu_count', document.getElementById('srv_vcpu_count').value || '');
      form.append('srv_memory_gb', document.getElementById('srv_memory_gb').value || '');
      form.append('srv_public_ipv4', document.getElementById('srv_public_ipv4').value || '');
      form.append('srv_ssh_user', document.getElementById('srv_ssh_user').value || '');
      form.append('srv_ssh_pass', document.getElementById('srv_ssh_pass').value || '');
      form.append('srv_ssh_keys', document.getElementById('srv_ssh_keys').value || '');
      var container = document.getElementById('sdws_rows_container');
      if (container){
        container.querySelectorAll('.sdws-row').forEach(function(row){
          var get = function(sel){ var el = row.querySelector(sel); return el ? el.value : ''; };
          form.append('sd_subdomain', get('input[name=sd_subdomain]'));
          form.append('sd_cloudflare', get('input[name=sd_cloudflare]'));
          form.append('sd_public_ipv4', get('input[name=sd_public_ipv4]'));
          form.append('ws_website', get('input[name=ws_website]'));
          form.append('ws_website_user', get('input[name=ws_website_user]'));
          form.append('ws_website_pass', get('input[name=ws_website_pass]'));
        });
      }
      var csrfEl = document.querySelector('#modalAddEditServer input[name=csrfmiddlewaretoken]');
      var csrf = csrfEl ? csrfEl.value : '';
      if (csrf) { form.append('csrfmiddlewaretoken', csrf); }
      var headers = { 'X-Requested-With': 'XMLHttpRequest' };
      if (csrf) { headers['X-CSRFToken'] = csrf; }
      var submitUrl = isAddMode ? '{% url "projects_task_technical_server_save" %}' : '{% url "projects_task_technical_subrow_update" %}';
      fetch(submitUrl, {
        method: 'POST',
        headers: headers,
        credentials: 'same-origin',
        body: form
      }).then(function(r){ return r.json(); }).then(function(resp){
        var ok = resp && (resp.status === true || resp.status === 'True');
        if (ok) {
          var msg = 'Data berhasil disimpan';
          if (window.Swal) {
            Swal.fire({icon: 'success', title: 'Berhasil', text: msg, timer: 1000, showConfirmButton: false}).then(function(){ window.location.reload() });
          } else {
            window.location.reload()
          }
        } else {
          var emsg = (resp && resp.message) ? resp.message : 'Gagal menyimpan';
          if (window.Swal) {
            Swal.fire({icon: 'error', title: 'Gagal', text: emsg});
          } else {
            alert(emsg);
          }
        }
      });
    });
  }
  var btnAdd = document.getElementById('btn_add_sdws_row');
  if (btnAdd){
    btnAdd.addEventListener('click', function(){
      var mdn=document.getElementById('modal_domain_name');
      var dname = mdn ? (mdn.value || '') : '';
      if (!dname && lastPartnerDomains && lastPartnerDomains.length){ dname = lastPartnerDomains[0].domain || ''; }
      appendSdwsRow({ public_ipv4: (document.getElementById('srv_public_ipv4').value || ''), domain_name: dname });
    });
  }
  // Edit subrow buttons
  document.querySelectorAll('.btn-edit-subrow').forEach(function(a){
    a.addEventListener('click', function(e){
      e.preventDefault();
      var modalEl = document.getElementById('modalAddEditServer');
      if (modalEl) modalEl.dataset.mode = 'edit';
      document.getElementById('btn_add_sdws_row').style.display = 'none';
      var pid = this.getAttribute('data-partner-id');
      var sid = this.getAttribute('data-subdomain-id');
      var hiddenPid = document.getElementById('modal_partner_id');
      if (hiddenPid) hiddenPid.value = pid;
      var sh = document.getElementById('sdwsHeader'); if (sh) sh.style.display = 'block';
      // clear fields
      ['lookup_ip','srv_public_ipv4','srv_hostname','srv_label','srv_vcpu_count','srv_memory_gb','srv_ssh_user','srv_ssh_pass','srv_ssh_keys'].forEach(function(id){ var el=document.getElementById(id); if(el){ el.value=''; el.classList.remove('is-invalid'); }});
      var rt = document.querySelector('.result-text'); if (rt){ rt.textContent=''; rt.classList.remove('text-danger','text-success'); }
      var cont = document.getElementById('sdws_rows_container'); if (cont) cont.innerHTML='';
      showModal();
      var url = '{% url "projects_task_technical_subrow_lookup" %}' + '?partner_id=' + encodeURIComponent(pid) + '&subdomain_id=' + encodeURIComponent(sid);
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(function(r){ return r.json(); })
        .then(function(resp){
          var srv = resp.server || {};
          setValues({server: srv}, srv.public_ipv4 || null);
          var s = resp.subrow || {};
          var dname = (resp.domain && resp.domain.domain) ? resp.domain.domain : '';
          appendSdwsRow({
            subdomain: s.subdomain,
            cloudflare: s.cloudflare,
            public_ipv4: s.public_ipv4,
            website: (resp.website && resp.website.website) ? resp.website.website : '',
            website_user: (resp.website && resp.website.website_user) ? resp.website.website_user : '',
            website_pass: (resp.website && resp.website.website_pass) ? resp.website.website_pass : '',
            domain_name: dname
          });
          var hiddenSid = document.getElementById('modal_subdomain_id');
          if (!hiddenSid){
            var h = document.createElement('input'); h.type='hidden'; h.id='modal_subdomain_id'; h.value=sid; document.getElementById('modalAddEditServer').appendChild(h);
          } else { hiddenSid.value = sid; }
        });
    });
  });
  document.querySelectorAll('.btn-delete-subrow').forEach(function(a){
    a.addEventListener('click', function(e){
      e.preventDefault();
      var pid = this.getAttribute('data-partner-id');
      var sid = this.getAttribute('data-subdomain-id');
      if (!confirm('Hapus subdomain ini?')) return;
      var form = new FormData();
      form.append('partner_id', pid);
      form.append('subdomain_id', sid);
      var csrfEl = document.querySelector('#modalAddEditServer input[name=csrfmiddlewaretoken]');
      var csrf = csrfEl ? csrfEl.value : '';
      if (csrf) { form.append('csrfmiddlewaretoken', csrf); }
      var headers = { 'X-Requested-With': 'XMLHttpRequest' };
      if (csrf) { headers['X-CSRFToken'] = csrf; }
      fetch('{% url "projects_task_technical_subrow_delete" %}', {
        method: 'POST',
        headers: headers,
        credentials: 'same-origin',
        body: form
      }).then(function(r){ return r.json(); }).then(function(resp){
        if (resp && resp.status === true) {
          var tr = a.closest('tr');
          if (tr) tr.remove();
          window.location.reload();
        } else {
          alert(resp && resp.message ? resp.message : 'Gagal menghapus');
        }
      });
    });
  });
  // Send to next flow (1002)
  document.querySelectorAll('.btn-send').forEach(function(a){
    a.addEventListener('click', function(e){
      e.preventDefault();
      var pid = this.getAttribute('data-partner-id');
      var prc = this.getAttribute('data-process-id');
      if (!window.Swal) {
        var ok = confirm('Kirim data ke proses berikutnya?');
        if (!ok) return;
        var form = new FormData();
        form.append('partner_id', pid);
        form.append('process_id', prc);
        var tokenEl = document.querySelector('input[name=csrfmiddlewaretoken]');
        var csrf = tokenEl ? tokenEl.value : '';
        if (csrf) { form.append('csrfmiddlewaretoken', csrf); }
        var headers = { 'X-Requested-With': 'XMLHttpRequest' };
        if (csrf) { headers['X-CSRFToken'] = csrf; }
        fetch('{% url "projects_task_technical_send" %}', { method: 'POST', headers: headers, credentials: 'same-origin', body: form })
          .then(function(r){ return r.json(); })
          .then(function(resp){
            var ok = resp && (resp.status === true || resp.status === 'True');
            if (ok) { window.location.reload(); } else { alert((resp && resp.message) || 'Gagal mengirim data'); }
          });
        return;
      }
      var html = ''+
        '<div class="text-left">'+
          '<label>Kirim Notifikasi ke:</label>'+
          '<select id="swal_recipients" multiple class="form-control select2" style="width:100%"></select>'+
          '<div class="form-check mt-3">'+
            '<input class="form-check-input" type="checkbox" id="swal_notify_email" checked>'+
            '<label class="form-check-label" for="swal_notify_email">Send Email Notification</label>'+
          '</div>'+
          '<div class="form-check mt-2">'+
            '<input class="form-check-input" type="checkbox" id="swal_notify_wa" checked>'+
            '<label class="form-check-label" for="swal_notify_wa">Send WhatsApp Notification</label>'+
          '</div>'+
        '</div>';
      Swal.fire({
        title: 'Kirim Data',
        html: html,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Send',
        cancelButtonText: 'Batal',
        showLoaderOnConfirm: true,
        allowOutsideClick: function(){ return !Swal.isLoading(); },
        didOpen: function(){
          var sel = $('#swal_recipients');
          $.ajax({
            url: '/settings/users/data/page',
            method: 'GET',
            success: function(resp){
              var items = (resp && resp.data_user) ? resp.data_user : [];
              items.forEach(function(u){
                var mail = (u.user_mail || '').trim();
                var alias = (u.user_alias || '').trim();
                if (!mail) return;
                var opt = $('<option>').attr('value', mail);
                opt.text(alias ? (alias) : mail);
              sel.append(opt);
            });
            sel.select2({ theme: 'bootstrap4', width: '100%', allowClear: true, placeholder: 'Pilih penerima' });
          }
        });
      },
        preConfirm: function(){
          var sendEmail = $('#swal_notify_email').is(':checked');
          var sendWa = $('#swal_notify_wa').is(':checked');
          var rec = $('#swal_recipients').val() || [];
          if (sendEmail && rec.length === 0) {
            Swal.showValidationMessage('Pilih minimal satu penerima untuk email');
            return false;
          }
          var form = new FormData();
          form.append('partner_id', pid);
          form.append('process_id', prc);
          (rec || []).forEach(function(v){ form.append('recipients[]', v); });
          form.append('notify_email', sendEmail ? '1' : '0');
          form.append('notify_whatsapp', sendWa ? '1' : '0');
          var tokenEl = document.querySelector('input[name=csrfmiddlewaretoken]');
          var csrf = tokenEl ? tokenEl.value : '';
          if (csrf) { form.append('csrfmiddlewaretoken', csrf); }
          var headers = { 'X-Requested-With': 'XMLHttpRequest' };
          if (csrf) { headers['X-CSRFToken'] = csrf; }
          return fetch('{% url "projects_task_technical_send" %}', { method: 'POST', headers: headers, credentials: 'same-origin', body: form })
            .then(function(r){ return r.json(); })
            .then(function(resp){
              var ok = resp && (resp.status === true || resp.status === 'True');
              if (!ok) {
                var emsg = (resp && resp.message) ? resp.message : 'Gagal mengirim data';
                Swal.showValidationMessage(emsg);
                throw new Error(emsg);
              }
              return resp;
            })
            .catch(function(){
              Swal.showValidationMessage('Terjadi kesalahan jaringan');
              throw new Error('network');
            });
        }
      }).then(function(result){
        if (!result.isConfirmed) return;
        var resp = result.value || {};
        var ok = resp && (resp.status === true || resp.status === 'True');
        if (ok) {
          Swal.fire({icon: 'success', title: 'Berhasil', text: 'Data dikirim ke proses berikutnya', timer: 1200, showConfirmButton: false}).then(function(){ window.location.reload(); });
        } else {
          var emsg = (resp && resp.message) ? resp.message : 'Gagal mengirim data';
          Swal.fire({icon: 'error', title: 'Gagal', text: emsg});
        }
      });
    });
  });
})();
</script>
{% endblock %}
{% block more_scripts %}
<script>
$(function(){
  function initSelect2(ctx){
    $(ctx).find('select.select2:visible').each(function(){
      if (!$(this).data('select2')) {
        $(this).select2({
            theme: 'bootstrap4',
            allowClear: true
        });
      }
    });
  }
  function loadKeywordsOptions(nid, target){
    nid = nid || '';
    var dfd = $.Deferred();
    if (!nid) {
      var scope = target ? target : $('#nk_groups .keyword-select');
      scope.each(function(){ $(this).empty(); });
      return dfd.resolve().promise();
    }
    $.ajax({
      url: '/projects/task/publisher/keywords-by-niche',
      method: 'GET',
      data: { niche_id: nid },
      success: function(resp){
        var items = (resp && resp.items) ? resp.items : [];
        var scope = target ? target : $('#nk_groups .keyword-select');
        scope.each(function(){
          var sel = $(this);
          var prev = sel.val() || [];
          sel.empty();
          items.forEach(function(it){
            var opt = $('<option>').attr('value', (it.keyword || ''));
            opt.text(it.keyword || '');
            sel.append(opt);
          });
          if (prev && prev.length) {
            sel.val(prev).trigger('change');
          } else {
            sel.trigger('change');
          }
        });
        dfd.resolve();
      },
      error: function(){ dfd.resolve(); }
    });
    return dfd.promise();
  }
  function addGroup(){
    var html = $('#nk_group_template').html();
    var el = $(html);
    $('#nk_groups').append(el);
    initSelect2(el);
  }
  $(document).on('click', '.btn-add-nk', function(e){
    e.preventDefault();
    var sid = $(this).data('subdomain-id') || '';
    $('#modal_subdomain_id').val(sid);
    $('#modal_action').val('');
    $('#modal_niche_id').prop('disabled', false).val('').trigger('change');
    $('#nk_groups').empty();
    addGroup();
    $('#modalAddNicheKeyword').modal('show');
  });
  $(document).on('click', '.btn-edit-nk', function(e){
    e.preventDefault();
    var sid = $(this).data('subdomain-id') || '';
    $('#modal_subdomain_id').val(sid);
    $('#modal_action').val('update');
    $('#nk_groups').empty();
    $.ajax({
      url: '/projects/task/publisher/keywords-load',
      method: 'GET',
      data: { subdomain_id: sid },
      success: function(resp){
        if (resp && resp.status === true) {
          var nid = resp.niche_id || '';
          if (nid) {
            $('#modal_niche_id').val(nid).trigger('change').prop('disabled', true);
          }
          var items = resp.items || [];
          if (!items.length) {
            addGroup();
          } else {
            items.forEach(function(it){
              addGroup();
              var g = $('#nk_groups .nk-group').last();
              var sel = g.find('select.keyword-select');
              sel.prop('multiple', false);
              try { sel.select2('destroy'); } catch(e){}
              sel.select2({ theme: 'bootstrap4', allowClear: true });
              loadKeywordsOptions(nid, sel).done(function(){
                if (it.keyword) { sel.val(it.keyword).trigger('change'); }
              });
              if (it.prompt_id) {
                g.find('select[name="prompt_id[]"]').val(String(it.prompt_id)).trigger('change');
              }
              g.find('select[name="status[]"]').val(it.status || 'posted').trigger('change');
            });
          }
          $('#modalAddNicheKeyword').modal('show');
        } else {
          var emsg = (resp && resp.message) ? resp.message : 'Gagal memuat data';
          if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: emsg}); } else { alert(emsg); }
        }
      },
      error: function(xhr){
        var msg = 'Gagal memuat data';
        try { msg = JSON.parse(xhr.responseText).message || msg; } catch(e){}
        if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: msg}); } else { alert(msg); }
      }
    });
  });
  $(document).on('click', '.btn-add-group', function(e){
    e.preventDefault();
    addGroup();
    var nid = $('#modal_niche_id').val() || '';
    var g = $('#nk_groups .nk-group').last();
    var sel = g.find('select.keyword-select');
    var act = ($('#modal_action').val() || '').toLowerCase();
    if (act === 'update') {
      sel.prop('multiple', false);
      try { sel.select2('destroy'); } catch(e){}
      sel.select2({ theme: 'bootstrap4', allowClear: true });
    }
    if (nid) {
      loadKeywordsOptions(nid, sel);
    }
  });
  $(document).on('click', '.btn-delete-nk', function(e){
    e.preventDefault();
    var sid = $(this).data('subdomain-id') || '';
    var doDelete = function(ok){
      if (!ok) return;
      var tokenEl = document.querySelector('input[name=csrfmiddlewaretoken]');
      var csrf = tokenEl ? tokenEl.value : '';
      $.ajax({
        url: '/projects/task/publisher/keywords-delete',
        method: 'POST',
        data: { subdomain_id: sid },
        headers: csrf ? { 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest' } : { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(resp){
          var ok = resp && (resp.status === true || resp.status === 'True');
          if (ok) {
            if (window.Swal) { Swal.fire({icon:'success', title:'Berhasil', text:'Semua keyword telah dihapus', timer:1000, showConfirmButton:false}).then(function(){ window.location.reload(); }); } else { window.location.reload(); }
          } else {
            var emsg = (resp && resp.message) ? resp.message : 'Gagal menghapus data';
            if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: emsg}); } else { alert(emsg); }
          }
        },
        error: function(xhr){
          var msg = 'Gagal menghapus data';
          try { msg = JSON.parse(xhr.responseText).message || msg; } catch(e){}
          if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: msg}); } else { alert(msg); }
        }
      });
    };
    if (window.Swal) {
      Swal.fire({icon:'question', title:'Hapus?', text:'Hapus semua keyword untuk subdomain ini?', showCancelButton:true, confirmButtonText:'Ya, hapus', cancelButtonText:'Batal'}).then(function(res){ doDelete(res && res.isConfirmed); });
    } else {
      var ok = confirm('Hapus semua keyword untuk subdomain ini?');
      doDelete(ok);
    }
  });
  $(document).on('click', '.btn-del-group', function(e){
    e.preventDefault();
    var g = $(this).closest('.nk-group');
    g.remove();
  });
  $('#modalAddNicheKeyword').on('shown.bs.modal', function(){
    initSelect2(this);
  });
  $('#modal_niche_id').on('change', function(){
    var nid = $(this).val();
    loadKeywordsOptions(nid);
  });
  $(document).on('click', '.btn-save-nk', function(e){
    e.preventDefault();
    var sid = $('#modal_subdomain_id').val();
    var nicheId = $('#modal_niche_id').val();
    var keywords = [];
    var promptIds = [];
    var statuses = [];
    $('#nk_groups .nk-group').each(function(){
      var pid = $(this).find('select[name="prompt_id[]"]').val() || '';
      var st = $(this).find('select[name="status[]"]').val() || 'posted';
      var sel = $(this).find('select.keyword-select');
      if (sel.length) {
        var isMulti = sel.prop('multiple');
        if (isMulti) {
          var arr = sel.val() || [];
          arr.forEach(function(kw){
            keywords.push(kw || '');
            promptIds.push(pid);
            statuses.push(st);
          });
        } else {
          var v = sel.val() || '';
          if (v) {
            keywords.push(v);
            promptIds.push(pid);
            statuses.push(st);
          }
        }
      }
    });
    $.ajax({
      url: '/projects/task/publisher/keywords-save',
      method: 'POST',
      data: {
        subdomain_id: sid,
        niche_id: nicheId,
        action: ($('#modal_action').val() || ''),
        'keyword[]': keywords,
        'prompt_id[]': promptIds,
        'status[]': statuses
      },
      success: function(resp){
        var ok = resp && (resp.status === true || resp.status === 'True');
        if (ok) {
          if (window.Swal) { Swal.fire({icon:'success', title:'Berhasil', text:'Data berhasil disimpan', timer: 1000, showConfirmButton: false}).then(function(){ window.location.reload(); }); } else { window.location.reload(); }
        } else {
          var emsg = (resp && resp.message) ? resp.message : 'Gagal menyimpan data';
          if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: emsg}); } else { alert(emsg); }
        }
      },
      error: function(xhr){
        var msg = 'Gagal menyimpan data';
        try { msg = JSON.parse(xhr.responseText).message || msg; } catch(e){}
        if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: msg}); } else { alert(msg); }
      }
    });
  });
  $('[data-niche-cell="1"]').each(function(){ 
    var cell = $(this);
    var sid = cell.data('subdomain-id') || '';
    if (!sid) return;
    $.ajax({
      url: '/projects/task/publisher/keywords-load',
      method: 'GET',
      data: { subdomain_id: sid },
      success: function(resp){
        if (resp && resp.status === true) {
          var nid = resp.niche_id || '';
          var items = resp.items || [];
          var cnt = items.length || 0;
          var name = '';
          if (nid) {
            name = $('#modal_niche_id option[value="'+ String(nid) +'"]').text() || '';
          }
          cell.find('.nk-niche-name').text((name || '').trim() ? name : '-');
          cell.find('.nk-keyword-total').text(cnt > 0 ? cnt : '-');
        }
      }
    });
    var dl = cell.find('input[name="article_deadline"]');
    if (dl && dl.length) {
      $.ajax({
        url: '{% url "projects_task_technical_subrow_lookup" %}',
        method: 'GET',
        data: { subdomain_id: sid },
        success: function(resp){
          var date = (resp && resp.website && resp.website.article_deadline) ? resp.website.article_deadline : '';
          if (date) {
            try { date = String(date).substr(0, 10); } catch(e){}
          }
          dl.val(date || '');
        }
      });
      dl.on('change', function(){
        var v = $(this).val() || '';
        var spinner = $('<span class="spinner-border spinner-border-sm ml-2 deadline-spinner" role="status" aria-hidden="true"></span>');
        $(this).after(spinner);
        $(this).prop('disabled', true);
        var tokenEl = document.querySelector('input[name=csrfmiddlewaretoken]');
        var csrf = tokenEl ? tokenEl.value : '';
        $.ajax({
          url: '{% url "projects_task_technical_website_deadline_update" %}',
          method: 'POST',
          data: { subdomain_id: sid, article_deadline: v },
          headers: csrf ? { 'X-CSRFToken': csrf, 'X-Requested-With': 'XMLHttpRequest' } : { 'X-Requested-With': 'XMLHttpRequest' },
          success: function(resp){
            var ok = resp && (resp.status === true || resp.status === 'True');
            if (ok) {
              if (window.Swal) { Swal.fire({toast: true, position: 'top-end', icon: 'success', title: 'Deadline updated', timer: 1200, showConfirmButton: false}); }
            } else {
              var emsg = (resp && resp.message) ? resp.message : 'Gagal memperbarui deadline';
              if (window.Swal) { Swal.fire({toast: true, position: 'top-end', icon: 'error', title: emsg}); } else { alert(emsg); }
            }
          },
          error: function(xhr){
            var msg = 'Gagal memperbarui deadline';
            try { msg = JSON.parse(xhr.responseText).message || msg; } catch(e){}
            if (window.Swal) { Swal.fire({toast: true, position: 'top-end', icon: 'error', title: msg}); } else { alert(msg); }
          },
          complete: function(){
            spinner.remove();
            dl.prop('disabled', false);
          }
        });
      });
    }
  });
});
</script>
{% endblock %}
