{% extends 'admin_base.html' %}

{% block page_title %}Edit Project{% endblock %}
{% block page_heading %}Edit Project{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">Task</li>
<li class="breadcrumb-item"><a href="/projects/task/draft">Draft</a></li>
<li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Edit Draft</h3>
        <div class="card-tools">
            <a href="{% url 'projects_task_draft' %}" class="btn btn-sm btn-secondary">
                <i class="bi bi-arrow-left"></i> Kembali
            </a>
        </div>
      </div>
      <div class="card-body">
        <form id="formEditProject" action="{% url 'projects_task_draft_edit' partner.partner_id %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="update" id="update_action" value="draft">
          <div class="form-row">
            <div class="form-group col-md-3">
              <label>ID</label>
              <input type="text" class="form-control" value="{{ partner.partner_id }}" readonly>
            </div>
            <div class="form-group col-md-3">
              <label>Tanggal Request</label>
              <input type="text" name="request_date" value="{% if partner.request_date %}{{ partner.request_date|date:'Y-m-d' }}{% endif %}" class="form-control datepicker-input" placeholder="YYYY-mm-dd" required>
            </div>
            <div class="form-group col-md-6">
              <label>Nama Partner</label>
              <input type="text" name="partner_name" value="{{ partner.partner_name }}" class="form-control" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Kontak</label>
              <input type="text" name="partner_contact" value="{{ partner.partner_contact }}" class="form-control" placeholder="08xxxxxxxxx">
            </div>
            <div class="form-group col-md-6">
              <label>Region</label>
              <input type="text" name="partner_region" value="{{ partner.partner_region }}" class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Ad Network</label>
              <select name="adnetwork" class="form-control select2" id="adnetwork_edit_select" data-placeholder="-- Pilih Ad Network --">
                <option value=""></option>
                <option value="adsense" {% if partner.adnetwork == 'adsense' %}selected{% endif %}>adsense</option>
                <option value="adx" {% if partner.adnetwork == 'adx' %}selected{% endif %}>adx</option>
                <option value="adsense &amp; adx" {% if partner.adnetwork == 'adsense & adx' %}selected{% endif %}>adsense &amp; adx</option>
              </select>
            </div>
            <div class="form-group col-md-6">
              <label>PIC</label>
              <select name="pic" class="form-control select2" id="pic_edit_select" data-placeholder="-- Pilih PIC --">
                <option value=""></option>
                {% for u in users %}
                  <option value="{{ u.user_alias }}" {% if partner.pic == u.user_alias %}selected{% endif %}>{{ u.user_alias }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Domain</label>
              <div class="input-group mb-3">
                <select name="domains" class="form-control select2-multiple" id="domain_edit_select" multiple data-placeholder="-- Pilih Domain --">
                    {% for d in domains %}
                    <option value="{{ d.domain_id }}" {% if d.domain_id in selected_domains %}selected{% endif %}>{{ d.domain_label }}</option>
                    {% endfor %}
                </select>
                <a href="{% url 'projects_master_domain' %}" class="btn btn-outline-primary" id="btn_add_domain"><i class="bi bi-plus"></i> Tambah Domain</a>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-success" name="update" value="draft" id="btn_submit_edit"><i class="bi bi-floppy2"></i> Simpan Draft</button>
            <button type="submit" class="btn btn-primary" name="update" value="send"><i class="bi bi-send"></i> Kirim ke Proses Selanjutnya</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block more_scripts %}
<script>
$(function(){
  if (window.jQuery && $.fn.select2) {
    $('#pic_edit_select').select2({
      theme: 'bootstrap4',
      tags: true,
      allowClear: true,
      placeholder: $('#pic_edit_select').data('placeholder') || '-- Pilih PIC --'
    });
    var currentPic = "{{ partner.pic|default:''|escapejs }}";
    if (currentPic) {
      var $sel = $('#pic_edit_select');
      var found = $sel.find('option').filter(function(){ return $(this).val() === currentPic; }).length > 0;
      if (!found) {
        var newOption = new Option(currentPic, currentPic, true, true);
        $sel.append(newOption).trigger('change');
      } else {
        $sel.val(currentPic).trigger('change');
      }
    }
    $('#domain_edit_select').select2({
      theme: 'bootstrap4',
      multiple: true,
      placeholder: $('#domain_edit_select').data('placeholder') || '-- Pilih Domain --'
    });
    $('#adnetwork_edit_select').select2({
      theme: 'bootstrap4',
      allowClear: true,
      placeholder: $('#adnetwork_edit_select').data('placeholder') || '-- Pilih Ad Network --'
    });
  }
  if (window.jQuery && $.fn.datepicker) {
    $('.datepicker-input').datepicker({
      format: 'yyyy-mm-dd',
      autoclose: true,
      todayHighlight: true
    });
  }
  $('#formEditProject').on('submit', function(e){
    e.preventDefault();
    var $btn = $('#btn_submit_edit');
    $btn.prop('disabled', true);
    var formData = $(this).serialize();
    $.ajax({
      url: $(this).attr('action'),
      method: 'POST',
      data: formData,
      dataType: 'json',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(resp){
        var ok = resp && (resp.status === true || resp.status === 'True');
        if (ok) {
          if (window.Swal) {
            Swal.fire({icon: 'success', title: 'Berhasil', text: resp.message}).then(function(){
              window.location.href = '{% url "projects_task_draft" %}';
            });
          } else {
            window.location.href = '{% url "projects_task_draft" %}';
          }
        } else {
          var emsg = (resp && resp.message) ? resp.message : 'Gagal menyimpan';
          if (window.Swal) {
            Swal.fire({icon: 'error', title: 'Gagal', text: emsg});
          } else {
            alert(emsg);
          }
          $btn.prop('disabled', false);
        }
      },
      error: function(xhr){
        var emsg = (xhr && xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : 'Terjadi kesalahan saat menyimpan';
        if (window.Swal) {
          Swal.fire({icon: 'error', title: 'Gagal', text: emsg});
        } else {
          alert(emsg);
        }
      },
      complete: function(){
        $btn.prop('disabled', false);
      }
    });
  });
  // Ensure clicked submit button value is included in AJAX data
  var lastSubmitBtn = null;
  $('#formEditProject').on('click', 'button[type=submit][name=update]', function(){
    lastSubmitBtn = this;
    var val = $(this).val() || 'draft';
    $('#update_action').val(val);
  });
  // SweetAlert modal with loading for Send to next process
  $(document).on('click', 'button[type=submit][name=update][value=send]', function(e){
    e.preventDefault();
    $('#update_action').val('send');
    var $form = $('#formEditProject');
    var actionUrl = $form.attr('action');
    if (!window.Swal) {
      var ok = confirm('Kirim data ke proses berikutnya?');
      if (!ok) return;
      var data = $form.serializeArray();
      data.push({name:'update', value:'send'});
      $.ajax({
        url: actionUrl,
        method: 'POST',
        data: data,
        dataType: 'json',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(resp){
          var ok = resp && (resp.status === true || resp.status === 'True');
          if (ok) { window.location.href = '{% url "projects_task_draft" %}'; } else { alert((resp && resp.message) || 'Gagal mengirim data'); }
        }
      });
      return;
    }
    var html = ''+
      '<div class="text-left">'+
        '<label>Kirim Notifikasi ke:</label>'+
        '<select id="swal_recipients" multiple class="form-control select2" style="width:100%"></select>'+
        '<div class="form-check mt-3">'+
          '<input class="form-check-input" type="checkbox" id="swal_notify_email" checked>'+
          '<label class="form-check-label" for="swal_notify_email">Send Email Notification</label>'+
        '</div>'+
        '<div class="form-check mt-2">'+
          '<input class="form-check-input" type="checkbox" id="swal_notify_wa" checked>'+
          '<label class="form-check-label" for="swal_notify_wa">Send WhatsApp Notification</label>'+
        '</div>'+
      '</div>';
    Swal.fire({
      title: 'Kirim Data',
      html: html,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'Send',
      cancelButtonText: 'Batal',
      showLoaderOnConfirm: true,
      allowOutsideClick: function(){ return !Swal.isLoading(); },
      didOpen: function(){
        var sel = $('#swal_recipients');
        $.ajax({
          url: '/settings/users/data/page',
          method: 'GET',
          success: function(resp){
            var items = (resp && resp.data_user) ? resp.data_user : [];
            items.forEach(function(u){
              var mail = (u.user_mail || '').trim();
              var alias = (u.user_alias || '').trim();
              if (!mail) return;
              var opt = $('<option>').attr('value', mail);
              opt.text(alias ? (alias) : mail);
              sel.append(opt);
            });
            sel.select2({ theme: 'bootstrap4', width: '100%', allowClear: true, placeholder: 'Pilih penerima' });
          }
        });
      },
      preConfirm: function(){
        var sendEmail = $('#swal_notify_email').is(':checked');
        var sendWa = $('#swal_notify_wa').is(':checked');
        var rec = $('#swal_recipients').val() || [];
        if (sendEmail && rec.length === 0) {
          Swal.showValidationMessage('Pilih minimal satu penerima untuk email');
          return false;
        }
        var data = $form.serializeArray();
        data.push({name:'update', value:'send'});
        (rec || []).forEach(function(v){ data.push({name:'recipients[]', value:v}); });
        data.push({name:'notify_email', value: sendEmail ? '1' : '0'});
        data.push({name:'notify_whatsapp', value: sendWa ? '1' : '0'});
        return new Promise(function(resolve, reject){
          $.ajax({
            url: actionUrl,
            method: 'POST',
            data: data,
            dataType: 'json',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(resp){
              var ok = resp && (resp.status === true || resp.status === 'True');
              if (!ok) {
                var emsg = (resp && resp.message) ? resp.message : 'Gagal mengirim data';
                Swal.showValidationMessage(emsg);
                reject(new Error(emsg));
              } else {
                resolve(resp);
              }
            },
            error: function(){
              Swal.showValidationMessage('Terjadi kesalahan jaringan');
              reject(new Error('network'));
            }
          });
        });
      }
    }).then(function(result){
      if (!result.isConfirmed) return;
      var resp = result.value || {};
      var ok = resp && (resp.status === true || resp.status === 'True');
      if (ok) {
        Swal.fire({icon:'success', title:'Berhasil', text: (resp && resp.message) ? resp.message : 'Data dikirim', timer:1200, showConfirmButton:false}).then(function(){ window.location.href = '{% url "projects_task_draft" %}'; });
      } else {
        var emsg = (resp && resp.message) ? resp.message : 'Gagal mengirim data';
        Swal.fire({icon:'error', title:'Gagal', text: emsg});
      }
    });
  });
  // When submitting via Enter key, keep hidden value default 'draft'
})
</script>
{% endblock %}
