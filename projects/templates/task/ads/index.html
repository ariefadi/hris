{% extends 'admin_base.html' %}

{% block page_title %}Ads{% endblock %}
{% block page_heading %}Ads{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">Task</li>
<li class="breadcrumb-item active"><a href="/projects/task/ads">Ads</a></li>
{% endblock %}

{% block content %}

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Ads</h3>
      </div>
      <div class="card-body">
        {% csrf_token %}
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th width="5%">No</th>
                <th width="20%">Subdomain</th>
                <th width="10%">Keitaro</th>
                <th width="20%">FB Account /<br>Interest</th>
                <th width="20%">Daily Budget /<br>Negara</th>
                <th width="10%"></th>
                <th width="5%"></th>
              </tr>
            </thead>
            <tbody>
              {% for g in groups %}
                {% for r in g.rows %}
                <tr>
                  <td class="align-middle">{{ g.offset|add:forloop.counter }}</td>
                  <td class="align-middle">
                    <u>{{ r.subdomain_name }}</u>
                    <br>
                    <b>Niche:</b> {{ r.niche|default:'' }}
                    <br>
                    <b>Keyword:</b> {{ r.keyword_total|default:'' }}
                  </td>
                  <td class="align-middle">
                    <button type="button" class="btn btn-xs btn-info btn-show-links" data-popover-id="popover-links-{{ r.subdomain_id }}"><i class="bi bi-eye"></i> Lihat Link</button>
                    <div id="popover-links-{{ r.subdomain_id }}" class="d-none">
                      <div><b>Keitaro</b></div>
                      <div style="white-space: pre-wrap">{{ r.tracker|default:'' }}</div>
                      <div class="mt-2"><b>Params</b></div>
                      <div style="white-space: pre-wrap">{{ r.tracker_params|default:'' }}</div>
                    </div>
                  </td>
                  <td class="align-middle">
                    <select class="form-control select2 sel-account" data-subdomain-id="{{ r.subdomain_id }}" data-placeholder="Pilih Account">
                      <option value=""></option>
                      {% for a in accounts %}
                        <option value="{{ a.account_ads_id }}" {% if r.account_ads_id_1 and r.account_ads_id_1 == a.account_ads_id %}selected="selected"{% endif %}>{{ a.account_name }}</option>
                      {% endfor %}
                    </select>
                    <br>
                    <select class="form-control select2 sel-page mt-1" data-subdomain-id="{{ r.subdomain_id }}" data-placeholder="Pilih Fanpage" data-saved-fanpage="{{ r.fanpage|default:'' }}">
                      <option value=""></option>
                    </select>
                    <div class="small text-muted sel-page-info"></div>
                    <br>
                    <textarea class="form-control input-interest" data-subdomain-id="{{ r.subdomain_id }}" placeholder="Interest" rows="3">{{ r.interest|default:'' }}</textarea>
                  </td>
                  <td class="align-middle">
                    <input type="number" class="form-control input-budget" value="{{ r.daily_budget|default:'' }}" data-subdomain-id="{{ r.subdomain_id }}" placeholder="Daily Budget">
                    <br>
                    <div class="mb-1">
                      <button class="btn btn-xs btn-outline-primary btn-tier" data-tier="1">Tier 1</button>
                      <button class="btn btn-xs btn-outline-secondary btn-tier" data-tier="2">Tier 2</button>
                      <button class="btn btn-xs btn-outline-warning btn-tier" data-tier="3">Tier 3</button>
                    </div>
                    <select class="form-control select2 sel-country" data-subdomain-id="{{ r.subdomain_id }}" multiple data-placeholder="Pilih Negara">
                      {% for c in countries %}
                        <option value="{{ c.negara_nm }}" data-tier="{{ c.tier }}" {% if r.country and c.negara_nm in r.country %}selected="selected"{% endif %}>{{ c.negara_nm }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td class="align-middle">
                    <button class="btn btn-sm btn-primary btn-update-ads" data-subdomain-id="{{ r.subdomain_id }}"><i class="bi bi-save"></i> Update</button>
                  </td>
                  {% if forloop.first %}
                  <td class="align-middle" rowspan="{{ g.rowspan }}">
                    <a href="#" class="btn btn-sm btn-success btn-send" data-partner-id="{{ g.partner_id }}" data-process-id="{{ g.process_id }}" title="Kirim"><i class="bi bi-send"></i></a>
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted">Belum ada data.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block more_scripts %}
<script>
(function(){
  function initSelect2(ctx){
    $(ctx).find('select.select2').each(function(){
      if (!$(this).data('select2')) {
        $(this).select2({ theme: 'bootstrap4', allowClear: true });
      }
    });
  }
  initSelect2(document);
  $(document).on('change', 'select.sel-account', function(){
    var $acc = $(this);
    var accId = ($acc.val() || '').trim();
    var $cell = $acc.closest('td');
    var $page = $cell.find('select.sel-page');
    var $info = $cell.find('.sel-page-info');
    if (!$page.length) return;
    function setLoading(){
      $page.prop('disabled', true);
      $page.html('<option value="">Memuat fanpage...</option>');
      $page.val(null).trigger('change');
      if ($info.length) { $info.text('Sedang mengambil data fanpage.'); }
    }
    function setReady(){
      $page.prop('disabled', false);
    }
    if (!accId) {
      $page.html('<option value=""></option>');
      $page.val(null).trigger('change');
      if ($info.length) { $info.text(''); }
      return;
    }
    var cacheKey = 'ads_pages_' + accId;
    var cached = null;
    try { cached = localStorage.getItem(cacheKey); } catch(e) {}
    var useCache = false;
    var pages = [];
    if (cached) {
      try {
        var obj = JSON.parse(cached) || {};
        var exp = parseInt(obj.expiresAt || '0', 10);
        if (exp && exp > Date.now() && Array.isArray(obj.pages)) {
          pages = obj.pages;
          useCache = true;
        }
      } catch(e) {}
    }
    if (useCache) {
      var html = '<option value=""></option>';
      for (var i=0;i<pages.length;i++){
        var p = pages[i] || {};
        var id = String(p.id || '');
        var name = String(p.name || id);
        html += '<option value="'+id.replace(/"/g,'&quot;')+'">'+name.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</option>';
      }
      $page.html(html);
      setReady();
      var saved = String(($page.attr('data-saved-fanpage') || '').trim());
      if (saved) {
        var matchVal = '';
        $page.find('option').each(function(){
          var t = ($(this).text() || '').trim();
          if (t === saved) { matchVal = this.value; return false; }
        });
        if (matchVal) {
          $page.val(matchVal).trigger('change');
        } else {
          $page.val(null).trigger('change');
        }
      } else {
        $page.val(null).trigger('change');
      }
      if ($info.length) { $info.text(pages.length + ' data fanpage ditemukan'); }
    } else {
      setLoading();
      fetch('{% url "projects_task_ads_pages" %}?account_ads_id=' + encodeURIComponent(accId), { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
        .then(function(r){ return r.json(); })
        .then(function(resp){
          var ok = resp && (resp.status === true || resp.status === 'True');
          pages = ok ? (resp.pages || []) : [];
          var html = '<option value=""></option>';
          for (var i=0;i<pages.length;i++){
            var p = pages[i] || {};
            var id = String(p.id || '');
            var name = String(p.name || id);
            html += '<option value="'+id.replace(/"/g,'&quot;')+'">'+name.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</option>';
          }
          $page.html(html);
          setReady();
          var saved = String(($page.attr('data-saved-fanpage') || '').trim());
          if (saved) {
            var matchVal = '';
            $page.find('option').each(function(){
              var t = ($(this).text() || '').trim();
              if (t === saved) { matchVal = this.value; return false; }
            });
            if (matchVal) {
              $page.val(matchVal).trigger('change');
            } else {
              $page.val(null).trigger('change');
            }
          } else {
            $page.val(null).trigger('change');
          }
          if ($info.length) { $info.text(pages.length + ' data fanpage ditemukan'); }
          try { localStorage.setItem(cacheKey, JSON.stringify({ pages: pages, expiresAt: Date.now() + 86400000 })); } catch(e) {}
        })
        .catch(function(){
          $page.html('<option value="">Gagal memuat fanpage</option>');
          $page.val(null).trigger('change');
          if ($info.length) { $info.text('Error: gagal mendapatkan data fanpage'); }
        });
    }
  });
  $('select.sel-account').each(function(){
    var v = ($(this).val() || '').trim();
    if (v) { $(this).trigger('change'); }
  });
  $(document).on('select2:open', function(e){
    var $sel = $(e.target);
    if (!$sel.is('select.sel-country')) return;
    var field = document.querySelector('.select2-container--open .select2-search__field');
    if (!field) return;
    if (field._pasteBound) return;
    field._pasteBound = true;
    field.addEventListener('paste', function(ev){
      var txt = '';
      try { txt = (ev.clipboardData && ev.clipboardData.getData('text')) || ''; } catch(x){}
      if (!txt && window.clipboardData) { try { txt = window.clipboardData.getData('Text') || ''; } catch(e){} }
      if (!txt) return;
      ev.preventDefault();
      var parts = txt.split(/[\s]*,[\s]*|\n|;+/).map(function(s){ return (s||'').trim(); }).filter(function(s){ return !!s; });
      if (!parts.length) return;
      var matches = [];
      $sel.find('option').each(function(){
        var val = (this.value||'').trim().toLowerCase();
        var txt2 = ($(this).text()||'').trim().toLowerCase();
        for (var i=0;i<parts.length;i++){
          var p = parts[i].toLowerCase();
          if (val === p || txt2 === p) { matches.push(this.value); break; }
        }
      });
      var existing = $sel.val() || [];
      var combined = Array.from(new Set(existing.concat(matches)));
      $sel.val(combined).trigger('change');
    });
  });
  $(document).on('click', '.btn-show-links', function(e){
    e.preventDefault();
    var $btn = $(this);
    var id = $btn.attr('data-popover-id');
    var el = document.getElementById(id);
    var html = el ? el.innerHTML : 'Tidak ada data';
    // Hide other popovers
    $('.btn-show-links').not($btn).each(function(){ var $b=$(this); if ($b.data('bs.popover')) { $b.popover('hide'); } });
    var inst = $btn.data('bs.popover');
    var visible = !!$btn.attr('aria-describedby');
    if (inst) {
      if (visible) { $btn.popover('hide'); } else { $btn.popover('show'); }
    } else {
      $btn.popover({html:true, content: html, container:'body', placement:'auto', trigger:'manual'});
      $btn.popover('show');
    }
  });
  // Click outside hides any open popovers
  $(document).on('click', function(e){
    if ($(e.target).closest('.popover, .btn-show-links').length === 0) {
      $('.btn-show-links').each(function(){ var $b=$(this); if ($b.data('bs.popover')) { $b.popover('hide'); } });
    }
  });
  document.querySelectorAll('.btn-tier').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      var tier = this.getAttribute('data-tier');
      var row = this.closest('tr');
      var sel = row.querySelector('select.sel-country');
      if (!sel) return;
      var values = [];
      sel.querySelectorAll('option').forEach(function(opt){
        var t = (opt.getAttribute('data-tier') || '').replace(/\s+/g,'').replace('Tier','');
        if (t === tier) values.push(opt.value);
      });
      var existing = $(sel).val() || [];
      var combined = Array.from(new Set(existing.concat(values)));
      $(sel).val(combined).trigger('change');
    });
  });
  document.querySelectorAll('.btn-update-ads').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      var sid = this.getAttribute('data-subdomain-id');
      var acc = document.querySelector('select.sel-account[data-subdomain-id="'+sid+'"]');
      var pageSel = document.querySelector('select.sel-page[data-subdomain-id="'+sid+'"]');
      var interest = document.querySelector('textarea.input-interest[data-subdomain-id="'+sid+'"]');
      var countriesSel = document.querySelector('select.sel-country[data-subdomain-id="'+sid+'"]');
      var budget = document.querySelector('input.input-budget[data-subdomain-id="'+sid+'"]');
      var form = new FormData();
      form.append('subdomain_id', sid);
      form.append('account_ads_id_1', acc ? acc.value : '');
      var fp = '';
      if (pageSel && pageSel.selectedIndex >= 0) {
        var opt = pageSel.options[pageSel.selectedIndex];
        fp = (opt && opt.text) ? opt.text.trim() : '';
      }
      form.append('fanpage', fp);
      form.append('interest', interest ? interest.value : '');
      var vals = $(countriesSel).val() || [];
      vals.forEach(function(v){ form.append('country[]', v); });
      form.append('daily_budget', budget ? budget.value : '');
      var tokenEl = document.querySelector('input[name=csrfmiddlewaretoken]');
      var csrf = tokenEl ? tokenEl.value : '';
      if (csrf) { form.append('csrfmiddlewaretoken', csrf); }
      var headers = { 'X-Requested-With': 'XMLHttpRequest' };
      if (csrf) { headers['X-CSRFToken'] = csrf; }
      fetch('{% url "projects_task_ads_update" %}', { method: 'POST', headers: headers, credentials: 'same-origin', body: form })
        .then(function(r){ return r.json(); })
        .then(function(resp){
          var ok = resp && (resp.status === true || resp.status === 'True');
          if (ok) {
            if (window.Swal) { Swal.fire({icon:'success', title:'Berhasil', text:'Ads diperbarui', timer:800, showConfirmButton:false}); } else { alert('Ads diperbarui'); }
          } else {
            var emsg = (resp && resp.message) ? resp.message : 'Gagal memperbarui Ads';
            if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: emsg}); } else { alert(emsg); }
          }
        });
    });
  });
  document.querySelectorAll('.btn-send').forEach(function(a){
    a.addEventListener('click', function(e){
      e.preventDefault();
      var pid = this.getAttribute('data-partner-id');
      var prc = this.getAttribute('data-process-id');
      // Validate required fields for the current partner group
      try {
        var span = parseInt(this.parentElement.getAttribute('rowspan') || '1', 10);
        var tr = this.closest('tr');
        var tbody = tr.parentElement;
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var startIndex = rows.indexOf(tr);
        var groupRows = rows.slice(startIndex, startIndex + (isNaN(span) ? 1 : span));
        var issues = [];
        groupRows.forEach(function(r){
          var subnameCell = r.children[1];
          var nm = subnameCell ? (subnameCell.textContent || '').trim() : '';
          var acc = r.querySelector('select.sel-account');
          var interest = r.querySelector('textarea.input-interest');
          var countriesSel = r.querySelector('select.sel-country');
          var budget = r.querySelector('input.input-budget');
          var missing = [];
          if (!acc || !(acc.value || '').trim()) missing.push('FB Account');
          if (!interest || !(interest.value || '').trim()) missing.push('Interest');
          var vals = (countriesSel ? $(countriesSel).val() : []) || [];
          if (!vals.length) missing.push('Countries');
          if (!budget || !(budget.value || '').trim()) missing.push('Daily Budget');
          if (missing.length) {
            issues.push(nm + ' (' + missing.join(', ') + ')');
          }
        });
        if (issues.length) {
          var msg = 'Lengkapi semua field sebelum kirim (wajib kecuali Avg CPC): ' + issues.join('; ');
          if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: msg}); } else { alert(msg); }
          return; // abort send
        }
      } catch(err) {
        var em = 'Validasi gagal. Pastikan FB Account, Interest, Countries, dan Daily Budget terisi.';
        if (window.Swal) { Swal.fire({icon:'error', title:'Gagal', text: em}); } else { alert(em); }
        return;
      }
      if (!window.Swal) {
        var ok = confirm('Kirim data ke proses berikutnya?');
        if (!ok) return;
        var form = new FormData();
        form.append('partner_id', pid);
        form.append('process_id', prc);
        var tokenEl = document.querySelector('input[name=csrfmiddlewaretoken]');
        var csrf = tokenEl ? tokenEl.value : '';
        if (csrf) { form.append('csrfmiddlewaretoken', csrf); }
        var headers = { 'X-Requested-With': 'XMLHttpRequest' };
        if (csrf) { headers['X-CSRFToken'] = csrf; }
        fetch('{% url "projects_task_ads_send" %}', { method: 'POST', headers: headers, credentials: 'same-origin', body: form })
          .then(function(r){ return r.json(); })
          .then(function(resp){
            var ok = resp && (resp.status === true || resp.status === 'True');
            if (ok) {
              window.location.reload();
            } else {
              var emsg = (resp && resp.message) ? resp.message : 'Gagal mengirim data';
              var list = (resp && resp.missing) ? resp.missing.join('; ') : '';
              if (list) { emsg = emsg + ': ' + list; }
              alert(emsg);
            }
          });
        return;
      }
      var html = ''+
        '<div class="text-left">'+
          '<label>Kirim Notifikasi Email ke:</label>'+
          '<select id="swal_recipients" multiple class="form-control select2" style="width:100%"></select>'+
          '<div class="form-check mt-3">'+
            '<input class="form-check-input" type="checkbox" id="swal_notify_email" checked>'+
            '<label class="form-check-label" for="swal_notify_email">Send Email Notification</label>'+
          '</div>'+
          '<div class="form-check mt-2">'+
            '<input class="form-check-input" type="checkbox" id="swal_notify_wa" checked>'+
            '<label class="form-check-label" for="swal_notify_wa">Send WhatsApp Notification</label>'+
          '</div>'+
        '</div>';
      Swal.fire({
        title: 'Kirim Data',
        html: html,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Send',
        cancelButtonText: 'Batal',
        showLoaderOnConfirm: true,
        allowOutsideClick: function(){ return !Swal.isLoading(); },
        didOpen: function(){
          var sel = $('#swal_recipients');
          var defaults = ['triosptr@trendhorizone.id','gen@trendhorizone.id','ayiikrnwn@trendhorizone.id'];
          defaults.forEach(function(mail){
            var opt = $('<option>').attr('value', mail).text(mail);
            sel.append(opt);
          });
          $.ajax({
            url: '/settings/users/data/page',
            method: 'GET',
            success: function(resp){
              var items = (resp && resp.data_user) ? resp.data_user : [];
              items.forEach(function(u){
                var mail = (u.user_mail || '').trim();
                var alias = (u.user_alias || '').trim();
                if (!mail) return;
                if (defaults.indexOf(mail) >= 0) return;
                var opt = $('<option>').attr('value', mail);
                opt.text(alias ? (alias) : mail);
                sel.append(opt);
              });
              sel.select2({ theme: 'bootstrap4', width: '100%', allowClear: true, placeholder: 'Pilih penerima', tags: true });
              sel.val(defaults).trigger('change');
            },
            error: function(){
              sel.select2({ theme: 'bootstrap4', width: '100%', allowClear: true, placeholder: 'Pilih penerima', tags: true });
              sel.val(defaults).trigger('change');
            }
          });
        },
        preConfirm: function(){
          var sendEmail = $('#swal_notify_email').is(':checked');
          var sendWa = $('#swal_notify_wa').is(':checked');
          var rec = $('#swal_recipients').val() || [];
          if (sendEmail && rec.length === 0) {
            Swal.showValidationMessage('Pilih minimal satu penerima untuk email');
            return false;
          }
          var form = new FormData();
          form.append('partner_id', pid);
          form.append('process_id', prc);
          (rec || []).forEach(function(v){ form.append('recipients[]', v); });
          form.append('notify_email', sendEmail ? '1' : '0');
          form.append('notify_whatsapp', sendWa ? '1' : '0');
          var tokenEl = document.querySelector('input[name=csrfmiddlewaretoken]');
          var csrf = tokenEl ? tokenEl.value : '';
          if (csrf) { form.append('csrfmiddlewaretoken', csrf); }
          var headers = { 'X-Requested-With': 'XMLHttpRequest' };
          if (csrf) { headers['X-CSRFToken'] = csrf; }
          return fetch('{% url "projects_task_ads_send" %}', { method: 'POST', headers: headers, credentials: 'same-origin', body: form })
            .then(function(r){ return r.json(); })
            .then(function(resp){
              var ok = resp && (resp.status === true || resp.status === 'True');
              if (!ok) {
                var emsg = (resp && resp.message) ? resp.message : 'Gagal mengirim data';
                var list = (resp && resp.missing) ? resp.missing.join('; ') : '';
                if (list) { emsg = emsg + ': ' + list; }
                throw new Error(emsg);
              }
            })
            .catch(function(err){
              Swal.showValidationMessage(err && err.message ? err.message : 'Gagal mengirim data');
            });
        }
      }).then(function(res){
        if (res && res.isConfirmed) {
          Swal.fire({icon: 'success', title: 'Berhasil', text: 'Data dikirim, status partner completed', timer: 1000, showConfirmButton: false})
            .then(function(){ window.location.reload(); });
        }
      });
    });
  });
})();
</script>
{% endblock %}
